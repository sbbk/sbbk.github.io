var Vertex,__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(s,r){function o(e){try{d(i.next(e))}catch(e){r(e)}}function a(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){e.done?s(e.value):new n((function(t){t(e.value)})).then(o,a)}d((i=i.apply(e,t||[])).next())}))};!function(e){e.Guid=class{static NewGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}}(Vertex||(Vertex={})),function(e){let t;!function(t){t.Component=class{constructor(){this.doNotSerialize=!1,this.events=new Map,this.isUpdatingState=!1,this.onChanged=new e.EventBus,this.onAdded=new e.EventBus,this.onRemoved=new e.EventBus,this.onChanged=new e.EventBus,this.onAdded=new e.EventBus,this.onRemoved=new e.EventBus}get Dirty(){return this.dirty}markDirty(){this.dirty=!0}clearDirty(){this.dirty=!1}triggerOnChanged(){this.isUpdatingState||(this.markDirty(),this.onChanged.trigger(this))}getNode(){return this.node}writeData(e,t){}readData(e){}writeDataBSON(e){let t=e.startObject();e.endObject(t)}readDataBSON(e){e.readObject(((e,t,n)=>{}))}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){e.EventHub=class{constructor(){this.events=new Map}on(e,n){var i=this.events.get(e);i||(i=new t,this.events.set(e,i)),i.on(n)}off(e,t){var n=this.events.get(e);n&&n.off(t)}fire(e,t){return __awaiter(this,void 0,void 0,(function*(){var n=this.events.get(e);n&&(yield n.trigger(t))}))}reset(e){var t=this.events.get(e);t&&t.reset()}};class t{constructor(){this.handlers=[]}on(e){this.handlers.push(e)}off(e){this.handlers=this.handlers.filter((t=>t!==e))}trigger(e){return __awaiter(this,void 0,void 0,(function*(){let t=this.handlers.slice(0);for(let n of t)yield n(e)}))}reset(){this.handlers=[]}expose(){return this}}e.EventBus=t;e.MonitoredEvent=class{constructor(e){this.handlers=[],this.target=e}on(e){this.handlers.push(e)}off(e){this.handlers=this.handlers.filter((t=>t!==e))}trigger(e){return __awaiter(this,void 0,void 0,(function*(){let t=this.handlers.slice(0);for(let n of t)yield n(e)}))}reset(){this.handlers=[]}expose(){return this}}}(Vertex||(Vertex={})),function(e){class t{constructor(){this.displayDebugContext=!1,this.displayDebugState=!1,this.debugState="",this.debugContext=null}setDebugState(e,t){this.debugState=e,this.debugContext=t,!0===this.displayDebugState&&console.debug("[VERTX:BinaryWriter]: "+this.debugState,this.displayDebugContext?this.debugContext:null)}}e.DebugReporter=t;e.BinaryWriter=class extends t{constructor(e){super(),this.littleEndian=!0,this.buffer=new Uint8Array(e),this.writer=new DataView(this.buffer.buffer),this.index=0}get Index(){return this.index}set Index(e){this.index=e}clear(){this.buffer.fill(0,0,this.buffer.length)}asBufferView(){return this.buffer.subarray(0,this.index)}toBuffer(){return this.buffer.buffer.slice(0,this.index)}dispose(){}writeSingle(e){this.writer.setFloat32(this.index,e,this.littleEndian),this.index+=4}writeDouble(e){this.writer.setFloat64(this.index,e,this.littleEndian),this.index+=8}writeInt16(e){this.writer.setInt16(this.index,e,this.littleEndian),this.index+=2}writeInt32(e){this.writer.setInt32(this.index,e,this.littleEndian),this.index+=4}writeUInt16(e){this.writer.setUint16(this.index,e,this.littleEndian),this.index+=2}writeUInt32(e){this.writer.setUint32(this.index,e,this.littleEndian),this.index+=4}writeBool(e){!0===e?this.buffer.set([1],this.index):this.buffer.set([0],this.index),this.index+=1}writeByte(e){this.buffer[this.index]=e,this.index+=1}writeString(t){if("string"==typeof t)if(null!==t)if(0!==t.length){var n=e.UTF8.Encode(t);this.write7BitEncodedInt(n.length),this.buffer.set(n,this.index),this.index+=n.length}else this.write7BitEncodedInt(0);else console.error("The string: "+t+" cannot be null");else console.error("The value of "+t+" must be a string")}writeBytes(e,t){this.buffer.set(e,this.index),this.index+=t}write7BitEncodedInt(e){e>256&&console.warn("Encoding huge string!! is this intentional?");for(var t=e>>>0;t>=128;)this.buffer[this.index]=128|t,this.index+=1,t=t>>7>>>0;this.buffer[this.index]=t,this.index+=1}writeArray(e){for(var t=new Uint8Array(e),n=0;n<t.byteLength;n++)this.buffer[this.index]=t[n],this.index++}}}(Vertex||(Vertex={})),function(e){class t extends e.DebugReporter{constructor(e){super(),this.littleEndian=!0,this.buffer=new Uint8Array(e),this.reader=new DataView(this.buffer.buffer),this.index=0}get Index(){return this.index}set Index(e){this.index=e}readSingle(){return this.index+=4,this.index>this.buffer.byteLength&&(new Error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength),console.error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength)),this.reader.getFloat32(this.index-4,this.littleEndian)}readDouble(){return this.index+=8,this.index>this.buffer.byteLength&&(new Error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength),console.error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength)),this.reader.getFloat64(this.index-8,this.littleEndian)}readInt16(){return this.index+=2,this.index>this.buffer.byteLength&&(new Error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength),console.error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength)),this.reader.getInt16(this.index-2,this.littleEndian)}readInt32(){return this.index+=4,this.index>this.buffer.byteLength&&(new Error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength),console.error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength)),this.reader.getInt32(this.index-4,this.littleEndian)}readUInt16(){return this.index+=2,this.index>this.buffer.byteLength&&(new Error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength),console.error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength)),this.reader.getUint16(this.index-2,this.littleEndian)}readUInt32(){return this.index+=4,this.index>this.buffer.byteLength&&(new Error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength),console.error("Length error with reader, index "+this.index+" is greater than the buffer length "+this.buffer.byteLength)),this.reader.getUint32(this.index-4,this.littleEndian)}readBool(){var e=this.buffer[this.index];return this.index+=1,0!==e}readByte(){return this.index+=1,this.buffer[this.index-1]}readBytes(e){let t=this.buffer.slice(this.index,this.index+e);return this.index+=e,t}peekByte(){return this.buffer[this.index+1]}readString(){var t=this.read7BitEncodedInt();if(0===t)return"";var n=e.UTF8.Decode(this.buffer.slice(this.index,this.index+t));return this.index+=t,n}read7BitEncodedInt(){let e,t=0,n=0,i=0;do{e=this.buffer[this.index+i++],t|=(127&e)<<n,n+=7}while(e>=128);return this.index+=i,t}readArray(){return null}skipAhead(e){this.index+=e}}e.BinaryReader=t}(Vertex||(Vertex={})),function(e){let t;!function(t){let n,i;!function(e){e[e.Layer1=2]="Layer1",e[e.Layer2=4]="Layer2",e[e.Layer3=8]="Layer3",e[e.Layer4=16]="Layer4",e[e.Layer5=32]="Layer5",e[e.Layer6=64]="Layer6",e[e.Layer7=128]="Layer7",e[e.Layer8=256]="Layer8",e[e.Layer9=512]="Layer9",e[e.Layer10=1024]="Layer10",e[e.Layer11=2048]="Layer11",e[e.Layer12=4096]="Layer12",e[e.Layer13=8192]="Layer13",e[e.Layer14=16384]="Layer14",e[e.Layer15=32768]="Layer15",e[e.Layer16=65536]="Layer16",e[e.Layer17=131072]="Layer17",e[e.Layer18=262144]="Layer18",e[e.Layer19=524288]="Layer19",e[e.Layer20=1048576]="Layer20",e[e.Layer21=2097152]="Layer21",e[e.Layer22=4194304]="Layer22",e[e.Layer23=8388608]="Layer23",e[e.Layer24=16777216]="Layer24",e[e.Layer25=33554432]="Layer25",e[e.Layer26=67108864]="Layer26",e[e.Layer27=134217728]="Layer27",e[e.Layer28=268435456]="Layer28",e[e.Layer29=536870912]="Layer29",e[e.Layer30=1073741824]="Layer30",e[e.Layer31=-2147483648]="Layer31",e[e.Layer32=1]="Layer32",e[e.AllLayers=4294967295]="AllLayers"}(n=t.Layer||(t.Layer={})),function(e){e[e.Binary=0]="Binary",e[e.BSON=1]="BSON",e[e.Json=2]="Json",e[e.BSONObject=3]="BSONObject"}(i=t.ComponentDataType||(t.ComponentDataType={}));var s=["Binary","BSON","Json","BSONObject"];let r;!function(e){e[e.Destroy=0]="Destroy",e[e.DestroyWithLastClient=1]="DestroyWithLastClient",e[e.Persist=2]="Persist",e[e.Portable=3]="Portable"}(r=t.TokenHandoffPolicy||(t.TokenHandoffPolicy={}));var o=["Destroy","DestroyWithLastClient","Persist","Portable"];let a;t.EnumAsString=function(e){return o[e]},function(e){e[e.None=0]="None",e[e.Distance=1]="Distance",e[e.Frequency=2]="Frequency",e[e.DistanceAndFrequency=3]="DistanceAndFrequency"}(a=t.LodPolicy||(t.LodPolicy={}));t.VertexNode=class{constructor(t,s){this.isDirty=!1,this.name="default",this.tokenHandoffPolicy=r.Destroy,this.tags=[],this.layer=n.Layer32,this.componentDataType=i.Binary,this.components=[],this.lodPolicy=a.None,this.lodDistance=0,this.doNotSerialize=!1,this.onDestroy=new e.EventBus,this.event=new e.EventHub,this.space=null,this.space=s,this.id=e.Guid.NewGuid(),this.parent="00000000-0000-0000-0000-000000000000",this.spaceId="00000000-0000-0000-0000-000000000000",this.componentSystem=t,this.hasToken=!1}get HasToken(){return this.hasToken}get HasChanges(){if(this.isDirty)return!0;for(var e of this.components){var t=this.componentSystem.getComponent(e,this);if(t&&t.Dirty)return!0}return!1}set HasChanges(e){for(var t of this.components){var n=this.componentSystem.getComponent(t,this);n&&(e?n.markDirty():n.clearDirty())}this.isDirty=e}get Space(){return this.space}createComponent(e){if(this.componentSystem)return this.componentSystem.createComponent(e);console.error("Entity "+this.id+" does not have a valid ComponentSystem reference")}addComponent(e,t=null){if(this.componentSystem){-1===this.components.findIndex(((t,n,i)=>t===e))&&this.components.push(e);var n=this.componentSystem.getComponent(e,this);return null===n&&(n=this.componentSystem.addComponent(e,this,t)),n.markDirty(),n}console.error("Entity "+this.id+" does not have a valid ComponentSystem reference")}getComponent(e){return this.componentSystem.getComponent(e,this)}removeComponent(e){this.componentSystem.removeComponent(e,this),this.HasChanges=!0;let t=this.components.indexOf(e);t>-1&&this.components.splice(t,1),this.hasToken&&(this.isDirty=!0)}acquireToken(e=r.Destroy,t){this.hasToken=!0;this.space.acquireToken(this,e,(e=>{t(e.result)}))}releaseToken(e=r.Destroy){this.space.releaseToken(this,e)}writeData(t,n){if(t.setDebugState("[VERTX:BinaryWriter:Node:"+this.id+"]",this),t.setDebugState("[VERTX:BinaryWriter:Node:Properties]",this),t.writeString(this.id),t.writeString(this.parent),t.writeString(this.spaceId),t.writeString(this.name),t.writeUInt32(this.layer),t.writeUInt32(this.tokenHandoffPolicy),t.writeUInt32(this.componentDataType),t.writeInt32(0),t.setDebugState("[VERTX:BinaryWriter:Node:Tags]",this),t.writeInt32(this.tags.length),this.tags.length>0)for(var s of this.tags)t.writeString(s);t.setDebugState("[VERTX:BinaryWriter:Node:Components]",this);var r=[],o=new e.BinaryWriter(2048),a=null;for(var d of(this.componentDataType===i.BSON&&(a=new e.BSONWriter(o)),o.displayDebugState=!1,this.components)){var c=this.componentSystem.getComponent(d,this);if(!c)throw console.error("Node Serialization Error. Context: ",{node:this,componentId:d,fetchedComponent:c}),new Error(`Critical Node Serialization Error:'getComponent' returned null for component '${d}'.\nMaybe this component isn't registered?`);var l=function(){r.push(d),o.writeUInt16(0);let e=o.Index;this.componentDataType===i.BSON?c.writeDataBSON(a):c.writeData(o,n);let t=o.Index,s=t-e;o.Index=e-2,o.writeUInt16(s),o.Index=t}.bind(this);!1===c.doNotSerialize&&(n?c.Dirty&&l():l())}for(var h of(t.writeInt32(r.length),r))t.writeString(h);var u=o.toBuffer();t.setDebugState("[VERTX:BinaryWriter:Node:ComponentData: "+u.byteLength+"bytes]",this),t.writeInt32(u.byteLength),t.writeArray(u),this.isDirty=!1}readData(e){e.setDebugState("[VERTX:BinaryWriter:Node:Properties]",this);try{this.id=e.readString(),this.parent=e.readString(),this.spaceId=e.readString(),this.name=e.readString(),this.layer=e.readUInt32(),this.tokenHandoffPolicy=e.readUInt32(),this.componentDataType=e.readInt32(),e.readInt32()}catch(e){console.error(e)}e.setDebugState("[VERTX:BinaryWriter:Node:Tags]",this);var t=e.readInt32();if(t>0){this.tags=[];for(var n=0;n<t;n++)this.tags[n]=e.readString()}e.setDebugState("[VERTX:BinaryWriter:Node:Components]",this);var i=e.readInt32();if(i>0){let t=this.components.slice(0);this.components=[];for(n=0;n<i;n++)this.components[n]=e.readString();for(let e of t)-1===this.components.indexOf(e)&&this.removeComponent(e)}e.setDebugState("[VERTX:BinaryWriter:Node:ComponentData]",this),this.updateComponentData(e),this.isDirty=!1}updateComponentData(t){var n=null;this.componentDataType===i.BSON&&(n=new e.BSONReader(t));t.readInt32();for(var s of(t.displayDebugState=!1,this.components.values())){var r=t.readUInt16(),o=t.Index;if(this.componentSystem.hasComponentSystem(s)){t.setDebugState("[VERTX:BinaryWriter:Node:ComponentData:"+s+"]",a);var a=this.getComponent(s);let e=!1;null===a&&(e=!0,a=this.createComponent(s));try{r>0&&(this.componentDataType===i.BSON?a.readDataBSON(n):a.readData(t))}catch(e){console.error(`[VERTX:Node] An unhandled error occured when deserializing a '${s}' Component.`,{node:this,componentName:s,component:a,componentLength:r,componentDataType:this.componentDataType})}if(e&&this.addComponent(s,a),a.triggerOnChanged(),a.clearDirty(),t.Index!==o+r){let e=this.componentDataType===i.BSON?"BSON":"Binary";console.error(`Deserialization [${e}] error for ${s}.\nStartIndex: ${o}, Expected Index: ${o+r} (${r} bytes), Actual Index: ${t.Index}`,a),t.Index=o+r}}else t.skipAhead(r)}}writeDataBSON(e){if(this.componentDataType!==i.BSONObject)return void console.error("Attempted to encode a component to BSON when it is in legacy mode!",this);let t=e.startObject();e.writeString("Id",this.id),e.writeString("Parent",this.parent),e.writeString("SpaceId",this.spaceId),e.writeString("TokenHandoffPolicy",o[this.tokenHandoffPolicy]),e.writeString("Name",this.name),e.writeArray("Tags",this.tags,e.writeString),e.writeInt32("Layer",this.layer),e.writeString("ComponentDataType",s[this.componentDataType]),e.writeArray("Components",this.components,e.writeString),e.writeObject("Data",this.writeComponentDataBSON.bind(this)),e.writeInt32("LodPolicy",this.lodPolicy),e.writeDouble("LodDistance",this.lodDistance),e.endObject(t)}writeComponentDataBSON(e){let t=e.startObject();for(let t of this.components){let n=this.getComponent(t);n&&e.writeObject(t,n.writeDataBSON.bind(n))}e.endObject(t)}bsonReadAction(t,n,i){if("Id"===t&&n===e.BsonType.String&&i.readString(this,"id"),"Parent"===t&&n===e.BsonType.String&&i.readString(this,"parent"),"SpaceId"===t&&n===e.BsonType.String&&i.readString(this,"spaceId"),"TokenHandoffPolicy"===t&&n===e.BsonType.String&&i.readEnum(this,"tokenHandoffPolicy",o),"Name"===t&&n===e.BsonType.String&&i.readString(this,"name"),"Tags"===t&&n===e.BsonType.Array&&i.readArray(this,"tags",i.readString),"Layer"===t&&n===e.BsonType.Int32&&i.readInt32(this,"layer"),"ComponentDataType"===t&&n===e.BsonType.String&&i.readEnum(this,"componentDataType",s),"Components"===t&&n===e.BsonType.Array){let e=this.components.slice(0);i.readArray(this,"components",i.readString);for(let t of e)-1===this.components.indexOf(t)&&this.removeComponent(t)}"Data"===t&&n===e.BsonType.Object&&i.readObject(this.readComponentDataBson.bind(this)),"LodPolicy"===t&&n===e.BsonType.Int32&&i.readInt32(this,"lodPolicy"),"LodDistance"===t&&n===e.BsonType.Double&&i.readDouble(this,"lodDistance")}readComponentDataBson(e,t,n){if(this.componentSystem.hasComponentSystem(e)){var i=this.getComponent(e);let t=!1;null===i&&(t=!0,i=this.createComponent(e));try{i.readDataBSON(n)}catch(t){console.error(`[VERTX:Node] An unhandled error occured when deserializing a '${e}' Component.`,{node:this,componentName:e,component:i,componentDataType:this.componentDataType})}t&&this.addComponent(e,i),i.triggerOnChanged(),i.clearDirty()}else n.readObjectBlind()}readDataBSON(e){this.componentDataType===i.BSONObject?e.readObject(this.bsonReadAction.bind(this)):console.error("Attempted to decode a component from BSON when it is in mode:",this.componentDataType,this)}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(t){t.ClientStats=class{constructor(){this.sentMessageCount=0,this.rcvMessageCount=0,this.bytesSent=0,this.bytesRecieved=0}};t.Client=class{constructor(t,n){this.isConnected=!1,this.openEvent=new e.EventBus,this.closeEvent=new e.EventBus,this.errorEvent=new e.EventBus,this.dataEvent=new e.EventBus,this.spaceId=n,this.uri=t,this.viewpointId=e.Guid.NewGuid(),console.log(`[VERTX:Client] Uri: ${this.uri}, SpaceId: ${this.spaceId}, ViewpointID: ${this.viewpointId}`)}get ViewpointId(){return this.viewpointId}connect(){return __awaiter(this,void 0,void 0,(function*(){}))}disconnect(){return __awaiter(this,void 0,void 0,(function*(){}))}sendData(e){return __awaiter(this,void 0,void 0,(function*(){}))}sendDataView(e){return __awaiter(this,void 0,void 0,(function*(){}))}}}(t=e.Net||(e.Net={}))}(Vertex||(Vertex={})),function(e){let t;!function(t){class n{constructor(){}writeData(e,t){}readData(e){}writeDataBSON(e){if(this.writeDataBSON===n.prototype.writeDataBSON){console.warn("This structure does not implement writeDataBSON. An empty BSON Object will be written.",this);const t=e.startObject();e.endObject(t)}else console.warn("Invoking super.writeDataBSON in is unnecessary and has performance implications",this)}readDataBSON(e){this.readDataBSON===n.prototype.readDataBSON?(console.warn("This structure does not implement readDataBSON. An empty BSON Object will be read.",this),e.readObjectBlind()):console.warn("Invoking super.readDataBSON is unnecessary and has performance implications",this)}}t.Structure=n;t.EmptyArgs=class extends n{};class i extends e.EventBus{constructor(e,t,n=!1){super(),this.eventName=e,this.structConstructor=t,this.isBroadcast=n||!1}fireWithArgs(e){this.trigger(e)}fireFromData(t){const n=new this.structConstructor;let i=!1;if(t instanceof e.BSONReader&&(n.readDataBSON(t),i=!0),t instanceof e.BinaryReader&&(n.readData(t),i=!0),!i)throw new Error("Unrecognized Reader Type");this.trigger(n)}fire(t,n){if(this.isBroadcast)if(!0!==t.node.HasToken)console.warn(`[VERTX] Not sending broadcast event because we do not control the node ${t.node.id}/${t.name}/${this.eventName}`);else{let i=e.Globals.getRuntime();console.assert(null!==i,"Could not find a valid Vertex Runtime object"),i.space.spaceLink.sendBroadcastMessage(t.node.id,t.name,this.eventName,n),this.trigger(n)}else if(t.node.HasToken)this.trigger(n);else{let i=e.Globals.getRuntime();console.assert(null!==i,"Could not find a valid Vertex Runtime object"),i.space.spaceLink.sendRPCMessage(t.node.id,t.name,this.eventName,n)}}}t.RPCEventBus=i}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){e[e.Test=0]="Test",e[e.Control=1]="Control",e[e.State=2]="State",e[e.Event=3]="Event",e[e.Destroy=4]="Destroy",e[e.Create=5]="Create",e[e.AcquireToken=6]="AcquireToken",e[e.AcquireTokenResult=7]="AcquireTokenResult",e[e.BroadcastEvent=8]="BroadcastEvent",e[e.ReleaseToken=9]="ReleaseToken",e[e.DCSubscribe=10]="DCSubscribe",e[e.DCMessage=11]="DCMessage",e[e.DCUnsubscribe=12]="DCUnsubscribe",e[e.BSONState=13]="BSONState",e[e.Heartbeat=14]="Heartbeat",e[e.Command=15]="Command",e[e.TickRateControl=16]="TickRateControl",e[e.ServerResponse=17]="ServerResponse",e[e.ViewpointControl=18]="ViewpointControl",e[e.Broadcast=19]="Broadcast"}(t=e.MessageType||(e.MessageType={}));class n{}e.TokenResult=n;e.DataChannel=class{constructor(t){this.onMessage=new e.EventBus,this.isInitialized=!1,this.spaceLink=t.spaceLink}init(){return __awaiter(this,void 0,void 0,(function*(){this.isInitialized||(this.isInitialized=!0,this.spaceLink?(console.log("[VERTX:DataChannel] Creating DataChannel: "+this.id),yield this.spaceLink.sendDCSubscribe(this.id,this)):console.error("[VERTX:DataChannel] This DataChannel does not have a valid SpaceLink"))}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){this.spaceLink?yield this.spaceLink.sendDCUnsubscribe(this.id,this):console.error("[VERTX:DataChannel] This DataChannel does not have a valid SpaceLink")}))}sendMessage(e){return __awaiter(this,void 0,void 0,(function*(){yield this.spaceLink.sendDCMessage(this.id,e)}))}};e.SpaceLink=class{constructor(n,i){this.readyEvent=new e.EventBus,this.updateTaskId=-1,this.heartbeatTaskId=-1,this.dispatchTable=[],this.onTokenAcquireResult=new e.EventBus,this.dataChannels=new Map,this.updateWriter=null,this.space=n,this.client=i;var s=this;this.client.openEvent.on((()=>{console.log("[VERTX:SpaceLink] Connected to socket"),this.readyEvent.trigger();s.updateTaskId=setInterval((function(){s.update()}),1e3/60);let e=sessionStorage&&sessionStorage.getItem("Vertex._clientHeartbeatDisabled")||null;e&&"false"!=e?console.warn("[VERTX:SpaceLink] The 'Vertex._clientHeartbeatDisabled' debug setting is set in SessionStorage.\nThis may cause unexpected disconnection on some VERTX Stacks."):s.heartbeatTaskId=setInterval((function(){s.sendHeartbeatMessage()}),2e3)})),this.client.closeEvent.on((()=>{console.warn("[VERTX:SpaceLink] Disconnected from socket"),-1!==this.updateTaskId&&clearInterval(this.updateTaskId)})),this.dispatchTable[t.Test]=this.handleNoMessage.bind(this),this.dispatchTable[t.Control]=this.handleNoMessage.bind(this),this.dispatchTable[t.State]=this.handleStateMessage.bind(this),this.dispatchTable[t.BSONState]=this.handleBSONStateMessage.bind(this),this.dispatchTable[t.Create]=this.handleNoMessage.bind(this),this.dispatchTable[t.Destroy]=this.handleDestroyMessage.bind(this),this.dispatchTable[t.Event]=this.handleRPCMessage.bind(this),this.dispatchTable[t.BroadcastEvent]=this.handleBroadcastMessage.bind(this),this.dispatchTable[t.AcquireTokenResult]=this.handleTokenAcquireResult.bind(this),this.dispatchTable[t.DCMessage]=this.handleDCMessage.bind(this),this.dispatchTable[t.Heartbeat]=this.handleHeartbeatMessage.bind(this),this.client.dataEvent.on((e=>{s.processMessage(e)}))}sendDCMessage(n,i){return __awaiter(this,void 0,void 0,(function*(){var s=new e.BinaryWriter(10240);s.writeByte(t.DCMessage),s.writeString(n),s.writeString(i);var r=s.toBuffer();yield this.client.sendData(r)}))}sendDCSubscribe(n,i){return __awaiter(this,void 0,void 0,(function*(){if(this.dataChannels.has(n))console.error("This SpaceLink already has a DataChannel with the id of: "+n);else{this.dataChannels[n]=i;var s=new e.BinaryWriter(4096);s.writeByte(t.DCSubscribe),s.writeString(n);var r=s.toBuffer();yield this.client.sendData(r)}}))}sendDCUnsubscribe(n,i){return __awaiter(this,void 0,void 0,(function*(){if(this.dataChannels.has(n)){this.dataChannels[n]=i;var s=new e.BinaryWriter(4096);s.writeByte(t.DCUnsubscribe),s.writeString(n);var r=s.toBuffer();yield this.client.sendData(r),this.dataChannels.delete(n)}else console.error("This SpaceLink does not have a DataChannel with the id of: "+n)}))}handleDCMessage(e){let t=e.readString(),n=e.readString(),i=this.dataChannels[t];i?i.onMessage.trigger(n):console.error("Got a DCMessage for context: "+t+" but that context was not found on this client")}processMessage(t){if(0!==t.byteLength){var n=new e.BinaryReader(t);n.setDebugState("[VERTX:SpaceLink] Got buffer: "+t.byteLength+"bytes",this);var i=n.readByte(),s=this.dispatchTable[i];"function"==typeof s?s(n):console.warn(`[SpaceLink] Cannot process message type: ${i}, ignoring...`)}else console.warn("Recieved empty buffer")}handleNoMessage(e){}handleHeartbeatMessage(e){return __awaiter(this,void 0,void 0,(function*(){e.setDebugState("[VERTX:SpaceLink:ControlMessage]",this),yield this.sendHeartbeatMessage()}))}handleStateMessage(e){e.setDebugState("[VERTX:SpaceLink:StateMessage]",this),this.space.readData(e)}handleBSONStateMessage(t){t.setDebugState("[VERTX:SpaceLink:StateMessage]",this),this.space.readDataBSON(new e.BSONReader(t))}sendHeartbeatMessage(){return __awaiter(this,void 0,void 0,(function*(){var n=new e.BinaryWriter(1);n.writeByte(t.Heartbeat),yield this.client.sendData(n.toBuffer())}))}sendDeleteMessage(n){return __awaiter(this,void 0,void 0,(function*(){var i=new e.BinaryWriter(50);i.writeByte(t.Destroy),i.writeInt32(1),i.writeString(n.id),yield this.client.sendData(i.toBuffer())}))}handleDestroyMessage(e){e.setDebugState("[VERTX:SpaceLink:DeleteMessage]",this);for(var t=e.readInt32(),n=0;n<t;n++){var i=e.readString(),s=this.space.findNode(i);s&&this.space.destroyNode(s,!1)}}handleBroadcastMessage(e){var t=e.readString(),n=e.readString(),i=e.readString(),s=this.space.findNode(t);if(s.HasToken)console.warn("Got Broadcast RPC for node with token ownership: "+t);else{var r=s.getComponent(n),o=r.events.get(i);o?o.fireFromData(e):console.error(`Recieved Broadcast RPC Message for event '${i}' on '${n}' of node ${t}, but no event with that name exists for that component.`,r,r.events)}}handleRPCMessage(e){var t=e.readString(),n=e.readString(),i=e.readString();console.debug(`[VERTX:SpaceLink:handleRPCMessage] Received RPC ${t}:${n} ${i}`);var s=this.space.findNode(t);if(s||console.warn(`[VERTX:SpaceLink:handleRPCMessage] Ignoring RPC '${i}' for ${t}:${n} because the node does not exist locally.`),s.HasToken){var r=s.getComponent(n);if(r){var o=r.events.get(i);o?o.fireFromData(e):console.error(`[VERTX:SpaceLink:handleRPCMessage] Ignoring RPC '${i}' for ${t}:${n} because the event does not exist on that component.`)}else console.error(`[VERTX:SpaceLink:handleRPCMessage] Ignoring RPC '${i}' for ${t}:${n} because that component does not exist on that node.`)}else console.debug(`[VERTX:SpaceLink:handleRPCMessage] Ignoring RPC '${i}' for ${t}:${n} because we don't have the token for that node.`)}sendRPCMessage(n,i,s,r){return __awaiter(this,void 0,void 0,(function*(){var o=this.space.findNode(n);if(o.HasToken){o.getComponent(i).events.get(s).fireWithArgs(r)}else{var a=new e.BinaryWriter(4096);a.writeByte(t.Event),a.writeString(n),a.writeString(i),a.writeString(s),r.writeData(a,!1);var d=a.toBuffer();yield this.client.sendData(d)}}))}sendBroadcastMessage(n,i,s,r){return __awaiter(this,void 0,void 0,(function*(){if(this.space.findNode(n).HasToken){var o=new e.BinaryWriter(4096);o.writeByte(t.BroadcastEvent),o.writeString(n),o.writeString(i),o.writeString(s),r.writeData(o,!1);var a=o.toBuffer();yield this.client.sendData(a)}}))}handleTokenAcquireResult(e){for(var t=new n,i=e.readInt32(),s=0;s<i;s++){if(t.id=e.readString(),t.context=e.readString(),t.result=e.readBool(),!1===t.result){var r=this.space.findNode(t.id);r&&(r.hasToken=!1)}this.onTokenAcquireResult.trigger(t)}}sendAcquireTokenMessage(n,i,s){return __awaiter(this,void 0,void 0,(function*(){var r=new e.BinaryWriter(4096);r.writeByte(t.AcquireToken),r.writeInt32(1),r.writeString(n),r.writeString(i),r.writeString(e.NodeComponentModel.EnumAsString(s));var o=r.toBuffer();yield this.client.sendData(o)}))}sendReleaseTokenMessage(n,i){return __awaiter(this,void 0,void 0,(function*(){var s=new e.BinaryWriter(4096);s.writeByte(t.ReleaseToken),s.writeInt32(1),s.writeString(n),s.writeString(e.NodeComponentModel.EnumAsString(i));var r=s.toBuffer();yield this.client.sendData(r)}))}connect(){return __awaiter(this,void 0,void 0,(function*(){yield this.client.connect()}))}update(){return __awaiter(this,void 0,void 0,(function*(){null==this.updateWriter&&(this.updateWriter=new e.BinaryWriter(51200)),this.updateWriter.clear();var n=this.updateWriter;n.Index=0;let i=n.Index;n.writeByte(t.State),this.space.writeData(n,!1),n.Index-i>5&&(yield this.client.sendDataView(n.asBufferView())),(n=this.updateWriter).Index=0,n.writeByte(t.BSONState);var s=new e.BSONWriter(n);this.space.writeDataBSON(s),n.Index-i>6&&(yield this.client.sendDataView(n.asBufferView()))}))}}}(Vertex||(Vertex={})),function(e){let t;!function(t){class n extends t.Client{constructor(e,n){super(e,n),this.socket=null,this.stats=new t.ClientStats}connect(){const t=e=>super[e];return __awaiter(this,void 0,void 0,(function*(){yield t("connect").call(this);var n=this;return new Promise(((t,i)=>{var s="?viewpointId="+encodeURIComponent(this.viewpointId)+"&spaceId="+encodeURIComponent(this.spaceId);e.Globals.bearerToken&&(s+="&bearerToken="+encodeURIComponent(e.Globals.bearerToken)),this.socket=new WebSocket(this.uri+s),this.socket.binaryType="arraybuffer",this.socket.onclose=e=>{console.warn(`WebSocket Closed: (WS Code: ${e.code}). Reason Given by Server:\n${e.reason}`),i(`WebSocket Closed: (WS Code: ${e.code}). Reason Given by Server:\n${e.reason}`),n.onClose(e)},this.socket.onerror=e=>{i(`WebSocket Error:\n${e.type}`);let t={message:"A WebSocket error ocurred",event:e};n.onError(t)},this.socket.onmessage=e=>{t(),n.onMessage(e)},this.socket.onopen=e=>{n.onOpen(e)}}))}))}disconnect(){const e=e=>super[e];return __awaiter(this,void 0,void 0,(function*(){console.log("[Vertex:WebSocketClient] Client called disconnect"),yield e("disconnect").call(this),this.socket&&this.socket.close(1e3,"Client called disconnect")}))}onClose(e){this.isConnected=!1,this.closeEvent.trigger(`Disconnect (${e.code}): ${e.reason}`)}onMessage(e){e.data instanceof ArrayBuffer&&this.dataEvent.trigger(e.data)}onOpen(e){this.isConnected=!0,this.openEvent.trigger()}onError(e){this.isConnected=!1,this.errorEvent.trigger(e)}sendData(t){return __awaiter(this,void 0,void 0,(function*(){this.isConnected&&(this.stats.sentMessageCount++,this.stats.bytesSent+=t.byteLength,e.Globals.networkStatsCallback.trigger(this.stats),this.socket.send(t))}))}sendDataView(t){return __awaiter(this,void 0,void 0,(function*(){this.isConnected&&(this.stats.sentMessageCount++,this.stats.bytesSent+=t.byteLength,e.Globals.networkStatsCallback.trigger(this.stats),this.socket.send(t))}))}}t.WebSocketClient=n}(t=e.Net||(e.Net={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){e.lookupSpace=function(e,t,n){return __awaiter(this,void 0,void 0,(function*(){if(!e)throw new Error("id is required");if(!t)throw new Error("stackHost is required");let i="vertx.cloud"===location.hostname||location.hostname.endsWith(".vertx.cloud");if(!n&&!i)throw new Error("token is required");try{const i=`https://${t}/core/directory/space/${e}`,s={method:"POST",credentials:"include",headers:{}};n&&(s.headers.Authorization=`Bearer ${n}`);const r=yield fetch(i,s);if(!r.ok){if(r.body){const t=yield r.text();console.warn(`[VERTX] Space Directory Lookup for '${e}' failed. (${r.status} ${r.statusText})`,t)}else console.warn(`[VERTX] Space Directory Lookup for '${e}' failed. (${r.status} ${r.statusText})`);return null}const o=yield r.json();if(!o)throw new Error("Directory Lookup returned unexpected value");return o}catch(e){return console.warn(`[VERTX] Space Directory Lookup failed. The directory API may not be available on the stack '${t}'.`,e),null}}))}}(t=e.SpaceDirectory||(e.SpaceDirectory={}))}(Vertex||(Vertex={})),function(e){e.Space=class{constructor(t,n){if(this.nodes=new Map,this.defaultComponentDataType=e.NodeComponentModel.ComponentDataType.BSONObject,this.tokenResultCallbacks=new Map,this.id=t,!0===n&&console.warn("[VERTX.Space] The 'connect' parameter of the Space constructor is obsolete."),!1===n)throw new Error("The 'connect' parameter of the Space constructor is obsolete")}get Id(){return this.id}get Name(){return this.name}init(){return __awaiter(this,void 0,void 0,(function*(){const t=yield e.SpaceDirectory.lookupSpace(this.id,e.Globals.vertexStackUrl,e.Globals.bearerToken),n=!!t&&!!t.server;if(!n){console.log("[VERTX] Space Directory lookup failed. Setting up Legacy SpaceLink...");const t=yield this.createLegacySpaceLink(`wss://${e.Globals.vertexStackUrl}/space/`);this.spaceLink=t}if(n)switch(console.log(`[VERTX] Space Directory lookup succeeded. Will connect to space ${t.spaceId} on ${t.server.url} using protocol ${t.server.protocol}`),t.server.protocol){case"wss/2.0":{const e=yield this.createSpaceLink2_0(t.server.url);this.spaceLink=e;break}case"wss/1.0":{const e=yield this.createLegacySpaceLink(t.server.url);this.spaceLink=e;break}default:throw new Error(`The current VERTX Runtime cannot connect to this space. The protocol '${t.server.protocol}' is not supported in this version.`)}this.spaceLink?(this.spaceLink.onTokenAcquireResult.on(this.onAcquireTokenCallback.bind(this)),yield this.spaceLink.connect(),this.spaceLink instanceof e.BSONSpaceLink&&(console.warn("[VERTX] Setting Client Viewpoint to [0,0,0] with a radius of 100m\nFor performance, specify a smaller radius and regularly update your Viewpoint by invoking space.setClientViewpoint()."),yield this.setClientViewpoint({position:[0,0,0],radius:100}),console.log("[VERTX] Requesting TickRate of 30Hz.\nFor higher/lower performance scenarios, invoke 'space.setClientTickrate(30)' to increase/decrease the message frequency from the space."),yield this.setClientTickrate(30))):console.warn("[VERTX] No SpaceLink is specified. The space will run in offline mode.")}))}createLegacySpaceLink(t){const n=new e.Net.WebSocketClient(t,this.id);return new e.SpaceLink(this,n)}createSpaceLink2_0(t){const n=e.Globals.runtime.createNetworkClient(t,this.id);return new e.BSONSpaceLink(this,n)}createNode(t){var n=new e.NodeComponentModel.VertexNode(e.Globals.runtime.componentSystem,this);return console.log("[VERTX:Space] Created local node: "+n.id),n.componentDataType=this.defaultComponentDataType,n.tokenHandoffPolicy=e.NodeComponentModel.TokenHandoffPolicy.Destroy,n.name=t,n.hasToken=!0,e.Globals.event.fire("space:nodeCreated",n),n}createNodeFromData(t){var n=new e.NodeComponentModel.VertexNode(e.Globals.runtime.componentSystem,this);return n.readData(t),console.log("[VERTX:Space] Created node from data: "+n.id),e.Globals.event.fire("space:nodeCreated",n),n}createNodeFromBSONData(t){var n=new e.NodeComponentModel.VertexNode(e.Globals.runtime.componentSystem,this);return n.componentDataType=e.NodeComponentModel.ComponentDataType.BSONObject,n.readDataBSON(t),console.log("[VERTX:Space] Created node from data: "+n.id),e.Globals.event.fire("space:nodeCreated",n),n}addNode(t){if(console.log("[VERTX:Space] Added node: "+t.id),this.nodes.has(t.id)?console.error("A node with the ID of "+t.id+" was already added to the space"):this.nodes.set(t.id,t),t.HasToken){for(var n of(t.HasChanges=!0,t.components))t.getComponent(n).triggerOnChanged();this.spaceLink.update()}e.Globals.event.fire("space:nodeAdded",t)}addNodeAndReleaseToken(e,t){this.addNode(e),e.HasToken&&e.releaseToken(t)}destroyNode(t,n=!0){console.log("[VERTX:Space] Removed node: "+t.id),n&&this.spaceLink.sendDeleteMessage(t);let i=t.components.slice(0,t.components.length).reverse();for(var s of i)try{t.removeComponent(s)}catch(e){console.error(`Unhandled error while removing ${s} Component`,{error:e,component:s,node:t})}t.onDestroy.trigger(t),t.event.fire("onDestroy",t),this.nodes.delete(t.id),e.Globals.event.fire("space:nodeDestroyed",t)}findNode(e){return this.nodes.has(e)?this.nodes.get(e):null}acquireToken(t,n,i){t.hasToken=!0,t.tokenHandoffPolicy=n;var s=t.id,r=e.Guid.NewGuid();this.spaceLink.sendAcquireTokenMessage(s,r,n),this.tokenResultCallbacks[r]=i}onAcquireTokenCallback(e){var t=this.tokenResultCallbacks[e.context];t&&t(e)}releaseToken(e,t){e.hasToken=!1,e.tokenHandoffPolicy=t,this.spaceLink.sendReleaseTokenMessage(e.id,t)}writeData(e,t){var n=[];for(var i of this.nodes.values())i.doNotSerialize||i.HasToken&&i.HasChanges&&(0===i.componentDataType||1===i.componentDataType)&&n.push(i);for(var s of(e.writeInt32(n.length),n.length>0&&(e.setDebugState("[VERTX:Space]",this),e.setDebugState("[VERTX:Space:"+n.length+" Nodes]",this)),n)){var r=s;e.writeString(r.id),r.writeData(e,t),r.HasChanges=!1}}writeDataBSON(t){var n=[];for(var i of this.nodes.values())i.doNotSerialize||i.HasToken&&i.HasChanges&&i.componentDataType===e.NodeComponentModel.ComponentDataType.BSONObject&&n.push(i);let s=t.startObject();for(let e of n)t.writeObject(e.id,e.writeDataBSON.bind(e)),e.HasChanges=!1;t.endObject(s)}readData(e){var t=e.readInt32();t>0&&(e.setDebugState("[VERTX:Space]",this),e.setDebugState("[VERTX:Space:"+t+" Nodes]",this));for(var n=0;n<t;n++){var i=e.readString();if(this.nodes.has(i))this.nodes.get(i).readData(e);else{var s=this.createNodeFromData(e);this.addNode(s)}}}bsonReadAction(e,t,n){if("_vertexmessagelog"===e){let e={message:""};return n.readString(e,"message"),void(e.message&&console.log("SpaceServerLog: ",e.message))}if(this.nodes.has(e))this.nodes.get(e).readDataBSON(n);else{var i=this.createNodeFromBSONData(n);this.addNode(i)}}readDataBSON(e){e.readObject(this.bsonReadAction.bind(this))}setClientTickrate(t){return __awaiter(this,void 0,void 0,(function*(){if(!(this.spaceLink instanceof e.BSONSpaceLink))throw new Error("The current Space does not support setting a client tickrate.");yield this.spaceLink.sendTickrateControlMessage(t)}))}setClientViewpoint(t){return __awaiter(this,void 0,void 0,(function*(){if(!(this.spaceLink instanceof e.BSONSpaceLink))throw new Error("The current Space does not support setting a Viewpoint.");{const{position:e,radius:n}=t;yield this.spaceLink.sendViewpointControlMessage(e,n)}}))}}}(Vertex||(Vertex={})),function(e){let t;!function(e){e.ComponentSystem=class{constructor(){this.systems=new Map}register(e){this.systems[e.name]?console.error(`[VERTX:ComponentSystem] A controller with the name ${e.name} already exists in the ComponentSystem`):(console.log("[VERTX:ComponentSystem] Registered component system "+e.name),this.systems.set(e.name,e))}override(e){this.systems[e.name]||(console.log("[VERTX:ComponentSystem] Override of component system "+e.name),this.systems.set(e.name,e))}init(){return __awaiter(this,void 0,void 0,(function*(){for(var e of this.systems.values())e.init()}))}hasComponentSystem(e){return this.systems.has(e)}addComponent(e,t,n=null){var i=this.systems.get(e);if(i){var s=i.addComponent(t,n);return s.name=e,s.node=t,s}console.error("A controller with the name "+e+" was not found in the ComponentSystem")}createComponent(e){var t=this.systems.get(e);return t?t.create():(console.error("A controller with the name "+e+" was not found in the ComponentSystem"),null)}getComponent(e,t){var n=this.systems.get(e);return n?n.getComponent(t):(console.error("A controller with the name "+e+" was not found in the ComponentSystem"),null)}removeComponent(e,t){var n=this.systems.get(e);return n?n.removeComponent(t):(console.error("A controller with the name "+e+" was not found in the ComponentSystem"),null)}update(){for(var e of this.systems.values())e.update()}render(){for(var e of this.systems.values())e.render()}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){class t{constructor(e){this.Message=e}}e.VertexRuntimeTaskResult=t;class n{}e.GraphicsEngine=n;e.VertexRuntime=class{constructor(){}setBearerToken(e){}postLoadComponentSystem(){}init(s){return __awaiter(this,void 0,void 0,(function*(){if(!this.isInitialized){this.graphics=new n,this.componentSystem=new e.NodeComponentModel.ComponentSystem,this.postLoadComponentSystem(),console.log("[VERTX:ComponentSystem] Register Component Systems"),yield i.event.fire("vertex:registerComponentSystems",this.componentSystem),console.log("[VERTX:ComponentSystem] End Register Component Systems");var r=i.spaceId;void 0===r&&(console.warn("[VERTX:VertexRuntime] No SpaceId was set in the Globals object, using temp space id: "+r),r=e.Guid.NewGuid()),yield e.Globals.event.fire("vertex:onBeforeConnect"),this.space=new e.Space(r);try{yield this.space.init(),console.log("Finished waiting for init")}catch(e){if(!s||!s.allowOffline)throw console.error("[VERTX:VertexRuntime] Space Connection Failed."),e;console.log("[VERTX:VertexRuntime] Running in offline mode because the Space connection failed and the 'allowOffline' option was enabled.")}var o=this;return i.event.fire("vertex:init",this),i.appContext.addEventListener("message",(function(e){e.data&&e.data.event&&i.event.fire(e.data.event,e.data.args)})),i.event.on("vertex:setAuthToken",(function(e){console.warn("Setting a new bearer token!"),o.setBearerToken(e)})),this.isInitialized=!0,new t("[VERTX:VertexRuntime] Init completed sucessfully")}console.warn("This instance of the runtime has already been loaded!")}))}render(){return __awaiter(this,void 0,void 0,(function*(){this.componentSystem.update(),this.componentSystem.render()}))}update(){return __awaiter(this,void 0,void 0,(function*(){}))}run(){return __awaiter(this,void 0,void 0,(function*(){}))}createNetworkClient(t,n){return new e.Net.WebSocketClient(t,n)}};class i{static getRuntime(){return i.runtime}static getEngine(){return i.runtime.engine}}i.canvasId="RenderCanvas",i.vertexStackUrl=window.location.host,i.canvas=document.getElementById(i.canvasId),i.runtime=null,i.networkStatsCallback=new e.EventBus,i.event=new e.EventHub,e.Globals=i}(Vertex||(Vertex={})),function(e){console.log("Loaded Vertex Runtime"),e.InitVertexHeadless=function(t,n){console.log("Init Runtime Headless"),e.Globals.runtime=new e.VertexRuntime,e.Globals.appContext=window,e.Globals.runtime.init(n).then((e=>{console.log(e.Message),t()}))},e.InitVertexHeadlessAsync=function(t){return __awaiter(this,void 0,void 0,(function*(){e.Globals.runtime=new e.VertexRuntime,e.Globals.appContext=window;let n=yield e.Globals.runtime.init(t);console.log("Runtime Headless Init Result:",n)}))}}(Vertex||(Vertex={})),function(e){class t{constructor(){this.nodes=[]}readDataBSON(e){let t=this;e.readObject(((n,i,s)=>{"nodes"===n&&e.readArray(t,"nodes",e.readString)}))}writeDataBSON(e){let t=e.startObject();e.writeArray("nodes",this.nodes,e.writeString),e.endObject(t)}}class n{constructor(){this.actions=[]}readDataBSON(e){let t=this;e.readObject(((n,s,r)=>{"actions"===n&&(t.actions=[],e.readObject(((n,s,r)=>{let o=parseInt(n);t.actions[o]=new i,t.actions[o].readDataBSON(e)})))}))}writeDataBSON(e){let t=e.startObject();e.writeObjectArray("actions",this.actions),e.endObject(t)}}class i{readDataBSON(t){t.readObject(((n,i,s)=>{if("node"===n&&t.readString(this,"id"),"context"===n&&t.readString(this,"context"),"result"===n&&t.readBoolean(this,"result"),"policy"===n){let i={policy:""};t.readString(i,"policy"),this.policy=e.NodeComponentModel.TokenHandoffPolicy[n]}}))}writeDataBSON(t){let n=t.startObject();t.writeString("node",this.id),t.writeString("context",this.context),t.writeBoolean("result",this.result),t.writeString("policy",e.NodeComponentModel.TokenHandoffPolicy[this.policy]),t.endObject(n)}}class s{readDataBSON(t){t.readObject(((n,i,s)=>{if("id"===n&&t.readString(this,"id"),"policy"===n){let i={policy:""};t.readString(i,"policy"),this.policy=e.NodeComponentModel.TokenHandoffPolicy[n]}}))}writeDataBSON(t){let n=t.startObject();t.writeString("id",this.id),t.writeString("policy",e.NodeComponentModel.TokenHandoffPolicy[this.policy]),t.endObject(n)}}class r{writeDataBSON(e){let t=e.startObject();e.writeString("node",this.node),e.writeString("component",this.component),e.writeString("command",this.command),this.args&&e.writeObject("args",this.args.writeDataBSON.bind(this.args)),e.endObject(t)}readDataBSON(e){e.readObject(((t,n,i)=>{"node"===t&&e.readString(this,"node"),"component"===t&&e.readString(this,"component"),"command"===t&&e.readString(this,"command"),"args"===t&&e.readObjectBlind(this,"argsBson")}))}}e.BSONSpaceLink=class{constructor(t,n){this.readyEvent=new e.EventBus,this.onTokenAcquireResult=new e.EventBus,this.client=null,this.space=null,this.updateTaskId=-1,this.updateRate=1e3/60,this.heartbeatTaskId=-1,this.updateWriter=null,this.dispatchTable=new Map,this.space=t,this.dispatchTable.set(e.MessageType.State,this.handleStateMessage.bind(this)),this.dispatchTable.set(e.MessageType.Destroy,this.handleDestroyMessage.bind(this)),this.dispatchTable.set(e.MessageType.AcquireTokenResult,this.handleTokenAcquireResult.bind(this)),this.dispatchTable.set(e.MessageType.Heartbeat,this.handleHeartbeatMessage.bind(this)),this.dispatchTable.set(e.MessageType.ServerResponse,this.handleServerResponseMessage.bind(this)),this.dispatchTable.set(e.MessageType.Command,this.handleCommandMessage.bind(this)),this.dispatchTable.set(e.MessageType.Broadcast,this.handleBroadcastMessage.bind(this)),this.client=n,this.client.openEvent.on(this.onClientOpenEvent.bind(this)),this.client.closeEvent.on(this.onClientCloseEvent.bind(this)),this.client.dataEvent.on(this.onClientDataEvent.bind(this)),this.client.errorEvent.on(this.onClientErrorEvent.bind(this))}handleStateMessage(e){this.space.readDataBSON(e)}handleDestroyMessage(e){let n=new t;if(n.readDataBSON(e),n.nodes.length>0)for(let e of n.nodes){let t=this.space.findNode(e);null!==t&&this.space.destroyNode(t,!1)}}handleHeartbeatMessage(e){e.readObjectBlind(),this.sendHeartbeatMessage()}handleServerResponseMessage(t){let n={};t.readObject(((i,s,r)=>{"message"==i&&s==e.BsonType.String?t.readString(n,"message"):console.warn(`[BSONSpaceLink] ServerResponse contained unrecognised BSON Property ${i}`)})),console.log(`[BSONSpaceLink] %cServer Message: %c${n.message}`,"font-weight: bold; color: cornflowerblue;","color: blue;")}handleTokenAcquireResult(e){let t=new i;t.readDataBSON(e),"null"!==t.context&&this.onTokenAcquireResult.trigger(t)}handleCommandMessage(t){let n=new r;n.readDataBSON(t);const i=this.space.findNode(n.node);if(!i)return void console.warn(`[BSONSpaceLink] Recieved Command message for ${n.node}/${n.component}/${n.command}, which could not be found locally.`,{message:n});if(!0!==i.HasToken)return void console.warn(`[BSONSpaceLink] Recieved Command message for ${n.node}/${n.component}/${n.command}, which we currently do not control.`,{message:n,node:i});const s=i.getComponent(n.component);if(!s)return void console.warn(`[BSONSpaceLink] Recieved Command message for ${n.node}/${n.component}/${n.command}, which the component is not recognized.`,{message:n,node:i});const o=s.events.get(n.command);if(!o)return void console.warn(`[BSONSpaceLink] Recieved Command message for ${n.node}/${n.component}/${n.command}, which does not contain this event locally.\n\nThe sender's component assembly may not match the local one.`,{message:n,node:i,component:s});const a=new e.BinaryReader(n.argsBson.buffer),d=new e.BSONReader(a);o.fireFromData(d)}handleBroadcastMessage(t){let n=new r;n.readDataBSON(t);const i=this.space.findNode(n.node);if(!i)return void console.warn(`[BSONSpaceLink] Recieved Broadcast message for ${n.node}/${n.component}/${n.command}, which could not be found locally.`,{message:n});if(!0===i.HasToken)return void console.warn(`[BSONSpaceLink] Recieved Broadcast message for ${n.node}/${n.component}/${n.command}, which we currently control.`,{message:n,node:i});const s=i.getComponent(n.component);if(!s)return void console.warn(`[BSONSpaceLink] Recieved Broadcast message for ${n.node}/${n.component}/${n.command}, which the component is not recognized.`,{message:n,node:i});const o=s.events.get(n.command);if(!o)return void console.warn(`[BSONSpaceLink] Recieved Broadcast message for ${n.node}/${n.component}/${n.command}, which does not contain this event locally.\n\nThe sender's component assembly may not match the local one.`,{message:n,node:i,component:s});const a=new e.BinaryReader(n.argsBson.buffer),d=new e.BSONReader(a);o.fireFromData(d)}onClientErrorEvent(e){console.error("[VERTX:BSONSpaceLink] A WebSocket Error Occurred",e)}onClientOpenEvent(){console.log("[VERTX:BSONSpaceLink] Connected to socket"),this.readyEvent.trigger(),this.updateTaskId=setInterval(function(){this.update()}.bind(this),this.updateRate);let e=sessionStorage&&sessionStorage.getItem("Vertex._clientHeartbeatDisabled")||null;e&&"false"!=e?console.warn("[VERTX:BSONSpaceLink] The 'Vertex._clientHeartbeatDisabled' debug setting is set in SessionStorage.\nThis may cause unexpected disconnection on some VERTX Stacks."):this.heartbeatTaskId=setInterval(function(){this.sendHeartbeatMessage()}.bind(this),2e3)}onClientCloseEvent(){console.warn("[VERTX:BSONSpaceLink] Disconnected from socket"),-1!==this.updateTaskId&&clearInterval(this.updateTaskId)}onClientDataEvent(t){let n=new e.BinaryReader(t),i=new e.BSONReader(n),s=null;i.readObject(((t,n,i)=>{let r=e.MessageType[t];s=this.dispatchTable.get(r),"function"==typeof s?s(i):(console.debug(`[BSONSpaceLink] Unknown ClientDataEvent ${t} (${r}) - skipping message...`),i.readObjectBlind())}))}connect(){return __awaiter(this,void 0,void 0,(function*(){console.log("[VERTX:BSONSpaceLink] Connecting..."),yield this.client.connect()}))}update(){return __awaiter(this,void 0,void 0,(function*(){yield this.createUpdateMessage()}))}createUpdateMessage(){return __awaiter(this,void 0,void 0,(function*(){null==this.updateWriter&&(this.updateWriter=new e.BinaryWriter(51200)),this.updateWriter.clear(),this.updateWriter.Index=0;let t=new e.BSONWriter(this.updateWriter),n=t.startObject(),i=t.writer.Index;yield this.sendStateMessage(t);let s=t.writer.Index-i;t.endObject(n),s>14&&this.client.sendDataView(this.updateWriter.asBufferView())}))}sendStateMessage(e){return __awaiter(this,void 0,void 0,(function*(){e.writeObject("State",this.space.writeDataBSON.bind(this.space))}))}_writeEmptyObject(e){const t=e.startObject();e.endObject(t)}sendHeartbeatMessage(){return __awaiter(this,void 0,void 0,(function*(){const t=new e.BinaryWriter(64),n=new e.BSONWriter(t),i=n.startObject();n.writeObject("Heartbeat",this._writeEmptyObject),n.endObject(i),yield this.client.sendDataView(t.asBufferView())}))}sendDCMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){console.warn("[BSONSpaceLink] sendDCMessage is not implemented")}))}sendDCSubscribe(e,t){return __awaiter(this,void 0,void 0,(function*(){console.warn("[BSONSpaceLink] sendDCSubscribe is not implemented")}))}sendDCUnsubscribe(e,t){return __awaiter(this,void 0,void 0,(function*(){console.warn("[BSONSpaceLink] sendDCUnsubscribe is not implemented")}))}sendDeleteMessage(n){return __awaiter(this,void 0,void 0,(function*(){let i=new t;i.nodes.push(n.id),null==this.updateWriter&&(this.updateWriter=new e.BinaryWriter(51200)),this.updateWriter.clear(),this.updateWriter.Index=0;let s=new e.BSONWriter(this.updateWriter),r=s.startObject();s.writeObject("Destroy",i.writeDataBSON.bind(i)),s.endObject(r),this.client.sendDataView(this.updateWriter.asBufferView())}))}sendRPCMessage(t,n,i,s){return __awaiter(this,void 0,void 0,(function*(){const o=new r;o.node=t,o.component=n,o.command=i,o.args=s;const a=new e.BinaryWriter(8192),d=new e.BSONWriter(a),c=d.startObject();d.writeObject("Command",o.writeDataBSON.bind(o)),d.endObject(c),this.client.sendDataView(a.asBufferView())}))}sendBroadcastMessage(t,n,i,s){return __awaiter(this,void 0,void 0,(function*(){const o=new r;o.node=t,o.component=n,o.command=i,o.args=s;const a=new e.BinaryWriter(8192),d=new e.BSONWriter(a),c=d.startObject();d.writeObject("Broadcast",o.writeDataBSON.bind(o)),d.endObject(c),this.client.sendDataView(a.asBufferView())}))}sendAcquireTokenMessage(t,s,r){return __awaiter(this,void 0,void 0,(function*(){let o=new i;o.id=t,o.context=s,o.policy=r,o.result=!0;let a=new n;a.actions.push(o),null==this.updateWriter&&(this.updateWriter=new e.BinaryWriter(51200)),this.updateWriter.clear(),this.updateWriter.Index=0;let d=new e.BSONWriter(this.updateWriter),c=d.startObject();d.writeObject("AcquireToken",a.writeDataBSON.bind(a)),d.endObject(c),this.client.sendDataView(this.updateWriter.asBufferView())}))}sendReleaseTokenMessage(t,n){return __awaiter(this,void 0,void 0,(function*(){let i=new s;i.id=t,i.policy=n,null==this.updateWriter&&(this.updateWriter=new e.BinaryWriter(51200)),this.updateWriter.clear(),this.updateWriter.Index=0;let r=new e.BSONWriter(this.updateWriter),o=r.startObject();r.writeObject("ReleaseToken",i.writeDataBSON.bind(i)),r.endObject(o),this.client.sendDataView(this.updateWriter.asBufferView())}))}sendTickrateControlMessage(t){return __awaiter(this,void 0,void 0,(function*(){const n=new e.BinaryWriter(64),i=new e.BSONWriter(n),s=i.startObject();i.writeObject("TickRateControl",(e=>{let n=e.startObject();e.writeDouble("frequencyHz",t),e.endObject(n)})),i.endObject(s),yield this.client.sendDataView(n.asBufferView())}))}sendViewpointControlMessage(t,n){return __awaiter(this,void 0,void 0,(function*(){const i=new e.BinaryWriter(256),s=new e.BSONWriter(i),r=s.startObject();s.writeObject("ViewpointControl",(e=>{let i=e.startObject();Array.isArray(t)&&3===t.length&&e.writeArray("position",t,e.writeDouble),"number"==typeof n&&e.writeDouble("radius",n),e.endObject(i)})),s.endObject(r),yield this.client.sendDataView(i.asBufferView())}))}}}(Vertex||(Vertex={}));class Transform{constructor(e,t,n){this.position=e,this.rotation=t,this.scale=n}}!function(e){let t;!function(e){e[e.Double=1]="Double",e[e.String=2]="String",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Binary=5]="Binary",e[e.Undefined=6]="Undefined",e[e.Oid=7]="Oid",e[e.Boolean=8]="Boolean",e[e.Date=9]="Date",e[e.Null=10]="Null",e[e.Regex=11]="Regex",e[e.Reference=12]="Reference",e[e.Code=13]="Code",e[e.Symbol=14]="Symbol",e[e.CodeWScope=15]="CodeWScope",e[e.Int32=16]="Int32",e[e.Int64=18]="Int64",e[e.TimeStamp=17]="TimeStamp",e[e.Single=19]="Single",e[e.Int16=20]="Int16",e[e.Uint8=21]="Uint8",e[e.UInt16=22]="UInt16",e[e.UInt32=23]="UInt32",e[e.UInt64=24]="UInt64",e[e.MinKey=-1]="MinKey",e[e.MaxKey=127]="MaxKey"}(t=e.BsonType||(e.BsonType={}));e.BSONWriter=class{constructor(e){this.writer=null,this.writer=e}writeInt16(e,n){this.writer.writeByte(t.Int16),this.writerCStringInternal(e),this.writer.writeInt16(n)}writeInt32(e,n){this.writer.writeByte(t.Int32),this.writerCStringInternal(e),this.writer.writeInt32(n)}writeInt64(e,t){console.error("this platform cannot encode 64 bit number as of yet")}writeUInt16(e,n){this.writer.writeByte(t.UInt16),this.writerCStringInternal(e),this.writer.writeUInt16(n)}writeUInt32(e,n){this.writer.writeByte(t.UInt32),this.writerCStringInternal(e),this.writer.writeUInt32(n)}writeUInt64(e,t){console.error("this platform cannot encode 64 bit number as of yet")}writeSingle(e,n){this.writer.writeByte(t.Double),this.writerCStringInternal(e),this.writer.writeDouble(n)}writeDouble(e,n){this.writer.writeByte(t.Double),this.writerCStringInternal(e),this.writer.writeDouble(n)}writeString(n,i){this.writer.writeByte(t.String),this.writerCStringInternal(n);var s=e.UTF8.Encode(i);this.writer.writeInt32(s.length+1),this.writer.writeBytes(s,s.length),this.writer.writeByte(0)}writeArray(e,n,i){i=i.bind(this),this.writer.writeByte(t.Array),this.writerCStringInternal(e);let s=this.startObject();for(let e=0;e<n.length;e++)i(e.toFixed(0).toString(),n[e]);this.endObject(s)}writeObjectArray(e,n){this.writer.writeByte(t.Array),this.writerCStringInternal(e);let i=this.startObject();for(let e=0;e<n.length;e++)this.writeObject(e.toFixed(0).toString(),n[e].writeDataBSON.bind(n[e]));this.endObject(i)}writeBoolean(e,n){this.writer.writeByte(t.Boolean),this.writerCStringInternal(e),this.writer.writeByte(n?1:0)}writeObject(e,n){this.writer.writeByte(t.Object),this.writerCStringInternal(e),n(this)}writeObjectBlind(e,n){this.writer.writeByte(t.Object),this.writerCStringInternal(e),this.writer.writeBytes(n,n.length)}startObject(){return this.beginBoundedSection()}endObject(e){this.writer.writeByte(0);this.endBoundedSection(e)}beginBoundedSection(){let e=this.writer.Index;return this.writer.writeInt32(0),e}endBoundedSection(e){let t=this.writer.Index,n=t-e;return this.writer.Index=e,this.writer.writeInt32(n),this.writer.Index=t,n}writerCStringInternal(t){var n=e.UTF8.Encode(t);this.writer.writeBytes(n,n.length),this.writer.writeByte(0)}};e.BSONReader=class{constructor(e){this.reader=null,this.reader=e}getTypeSize(e){switch(e){case 0:return 0;case t.Double:return 8;case t.String:{let e=this.reader.Index,t=this.reader.readInt32()+4;return this.reader.Index=e,t}case t.Object:{let e=this.reader.Index,t=this.reader.readInt32();return this.reader.Index=e,t}case t.Array:{let e=this.reader.Index,t=this.reader.readInt32();return this.reader.Index=e,t}case t.Boolean:return 1;case t.Int32:return 4;case t.Int64:return 8;case t.Single:return 4;case t.Int16:return 2;case t.Uint8:return 1;case t.UInt16:return 2;case t.UInt32:return 4;case t.UInt64:return 8;default:return console.error("Attempted to deserialize BSON type: "+e+" which is not supported by this serializer"),0}}readCStringInteral(){let t=[],n=this.reader.readByte();for(;0!=n;)t.push(n),n=this.reader.readByte();return e.UTF8.Decode(t)}readInt16(e,t){e[t]=this.reader.readInt16()}readInt32(e,t){e[t]=this.reader.readInt32()}readInt64(e,t){console.error("BSON Reader: This platform does not support property type Int64")}readUInt16(e,t){e[t]=this.reader.readUInt16()}readUInt32(e,t){e[t]=this.reader.readUInt32()}readUInt64(e,t){console.error("BSON Reader: This platform does not support property type UInt64")}readSingle(e,t){e[t]=this.reader.readDouble()}readDouble(e,t){e[t]=this.reader.readDouble()}readString(e,t){e[t]=this.readStringInternal()}readEnum(e,t,n){let i=this.readStringInternal();for(var s=0;s<n.length;s++)n[s]==i&&(e[t]=s)}readStringInternal(){let t=this.reader.readInt32(),n=this.reader.readBytes(t-1);return 0!=this.reader.readByte()&&console.error("BSON Reader: Malformed string detected in BSON string bytestream"),e.UTF8.Decode(n)}readBoolean(e,t){e[t]=1===this.reader.readByte()}readArray(e,t,n){n=n.bind(this);let i=e[t],s=0;this.readObject(((e,t,r)=>{i.length<s+1&&i.push(null),n(i,parseInt(e)),s++})),i.length>s&&(e[t]=i.slice(0,s))}readObjectBlind(e,t){if(void 0===e){let e=this.reader.readInt32();e-=4;const t=this.reader.Index;this.reader.skipAhead(e-1);0!=this.reader.readByte()&&console.warn("[BSONReader] BSON document did not properly deserialize!");this.reader.Index-t+5!==e+5&&console.warn("[BSONReader] BSON Reader did not read the correct number of bytes for the document")}else{const n=this.reader.readInt32();if(this.reader.skipAhead(-4),n>32768)return console.warn(`[BSONReader] Refusing to blind read large (>32M) BSON object (Declared Size: ${n} bytes)`),this.readObjectBlind(void 0,void 0);const i=this.reader.readBytes(n),s=i[i.length-1];0!==s&&console.warn("[BSONReader] BSON document did not properly deserialize!",{document:i,detectedEndMarker:s}),e[t]=i}}readObject(e){let t=this.reader.readInt32();if(t-=4,0===t)return void this.reader.readByte();let n=0,i=this.reader.Index;for(;n<t-1;){let t=this.reader.readByte(),s=this.readCStringInteral(),r=this.reader.Index,o=this.getTypeSize(t);e(s,t,this),this.reader.Index===r&&o>0&&this.reader.skipAhead(o),n=this.reader.Index-i}0!=this.reader.readByte()&&console.warn("BSON document did not properly deserialize!"),this.reader.Index-i+5!==t+5&&console.warn("BSON Reader did not read the correct number of bytes for the document")}}}(Vertex||(Vertex={})),function(e){e.UTF8=class{static Encode(e){for(var t=[],n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(n++,i=(1023&i)<<10|1023&e.charCodeAt(n),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return t}static Decode(e){var t,n="";for(t=0;t<e.length;t++){var i=e[t];if(i<128)n+=String.fromCharCode(i);else if(i>191&&i<224)n+=String.fromCharCode((31&i)<<6|63&e[t+1]),t+=1;else if(i>223&&i<240)n+=String.fromCharCode((15&i)<<12|(63&e[t+1])<<6|63&e[t+2]),t+=2;else{var s=((7&i)<<18|(63&e[t+1])<<12|(63&e[t+2])<<6|63&e[t+3])-65536;n+=String.fromCharCode(s>>10|55296,1023&s|56320),t+=3}}return n}}}(Vertex||(Vertex={})),function(e){let t;!function(e){class t{update(){}render(){}}e.ComponentViewBase=t;class n extends t{addComponent(e,t){}removeComponent(e,t){}update(){}render(){}}e.EmptyComponentView=n;class i{update(){}render(){}}e.ComponentControllerBase=i;class s extends i{constructor(){super()}addComponent(e,t){}removeComponent(e,t){}}e.EmptyComponentController=s;class r{constructor(e,t,n){this.components=new Map,this.name=e,this.view=t,this.controller=n}init(){}update(){this.controller.update(),this.view.update()}render(){this.controller.render(),this.view.render()}addComponent(e,t=null){if(this.components.has(e.id))return this.components.get(e.id);var n=null===t?this.create():t;return this.components.set(e.id,n),this.view.addComponent(n,e),e.HasToken&&this.controller.addComponent(n,e),n}getComponent(e){return this.components.has(e.id)?this.components.get(e.id):null}removeComponent(e){if(this.components.has(e.id)){var t=this.components.get(e.id);t.onRemoved.trigger(),this.view.removeComponent(t,e),this.controller.removeComponent(t,e),this.components.delete(e.id)}}}e.ComponentSystemBase=r;e.EmptyComponentSystem=class extends r{constructor(e){var t=e.name;t.endsWith("Component")&&(t=t.substring(0,t.length-9)),super(t,new n,new s),this.componentClass=e,console.log(`[VERTX:EmtpyComponentSystem] Created EmptyComponentSystem for ${t}`,{class:e,name:t,componentSystem:this})}create(){if(this.componentClass){return new this.componentClass}console.error("[VERTX:EmtpyComponentSystem:create] Could not initialize constructor for "+this.name)}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){const t="bcdfghjklmnpqrstvwxyzBCDFGHJKLMNPQRSTVWXYZ_-";function n(){let e="";for(let n=0;n<16;++n){let n=Math.round(Math.random()*(t.length-1));e+=t.charAt(n)}return e}function i(e,t){if(e.transaction!=t.transaction)throw new Error("Wrong transaction")}function s(e){if(e.statusCode<200||e.statusCode>=300)throw console.log("Janus non-success status",e),new Error("Expected success status");let t=e.body&&e.body.janus;if(t&&"error"==t)throw console.log("Janus error response",e),new Error("Expected non-error janus response")}e.JanusApi=class{constructor(e){this.janusBase=`${e}webrtc/`}setBearerToken(e){this.token=e}prepareInit(e){let t={};return t.method=e,t.headers={"Content-Type":"application/json"},t.credentials="same-origin",this.token&&(t.credentials="include",t.headers.Authorization=`Bearer ${this.token}`),t}createVertexWebRtcSessionAsync(e,t,n,i){return __awaiter(this,void 0,void 0,(function*(){var s=`${this.janusBase}join`,r=[`spaceId=${encodeURIComponent(e)}`,`viewpointId=${encodeURIComponent(t)}`];n&&r.push("debugvp8room=true"),i&&r.push("debugh264room=true");var o=`${s}?${r.join("&")}`;let a=this.prepareInit("post"),d=yield fetch(o,a);return yield d.json()}))}sendVertexKeepAlive(e,t,n){return __awaiter(this,void 0,void 0,(function*(){var i=`${`${this.janusBase}join/keepalive`}?${[`spaceId=${encodeURIComponent(e)}`,`viewpointId=${encodeURIComponent(t)}`,`sessionId=${n}`].join("&")}`;let s=this.prepareInit("post");return(yield fetch(i,s)).ok}))}getSessionInfoAsync(e){return __awaiter(this,void 0,void 0,(function*(){var t={responseBody:null,error:null};try{let n=`${this.janusBase}janus/${e}`,i=yield this.sendJanusRequestGet(n);if(!i||!i.body)throw new Error("Unexpected response from server");t.responseBody=i.body}catch(e){t.error=e}return t}))}createVideoRoomPluginHandle(e){return __awaiter(this,void 0,void 0,(function*(){var t={handle:0,error:null};try{var r={janus:"attach",plugin:"janus.plugin.videoroom",transaction:n()},o=yield this.sendJanusSessionRequest(e,r);s(o);var a=o.body;s(a),i(r,a),t.handle=a.data.id,console.debug("[WebRTC] Created videoroom session",a)}catch(e){t.error=e}return t}))}detachPluginHandle(e,t){return __awaiter(this,void 0,void 0,(function*(){var r={handle:0,error:null};try{var o={janus:"detach",transaction:n()},a=yield this.sendJanusPluginRequest(e,t,o);s(a);var d=a.body;s(d),i(o,d)}catch(e){r.error=e}return r}))}joinVideoRoomAsPublisher(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){try{let o={janus:"message",transaction:n(),body:{request:"join",ptype:"publisher",room:i,display:r}},a=yield this.sendJanusPluginRequest(e,t,o);return s(a),console.debug("[WebRTC] Joined as publisher",a.body),{}}catch(e){return{error:e}}}))}leaveVideoRoom(e,t){return __awaiter(this,void 0,void 0,(function*(){try{let i={janus:"message",transaction:n(),body:{request:"leave"}},r=yield this.sendJanusPluginRequest(e,t,i);return s(r),console.debug("[WebRTC] Left videoroom",r.body),{}}catch(e){return{error:e}}}))}videoRoomSubscribe(e,t,i,r,o,a){return __awaiter(this,void 0,void 0,(function*(){try{if(0==t)throw new Error("invalid handle");let d={janus:"message",transaction:n(),body:{request:"join",ptype:"subscriber",room:r,feed:i,audio:o,video:a,offer_audio:o,offer_video:a,close_pc:!1}};console.debug("[WebRTC] Joining as subscriber...",{message:d,handle:t});let c=yield this.sendJanusPluginRequest(e,t,d);return s(c),console.debug("[WebRTC] Joined as subscriber",c.body),{}}catch(e){return{error:e}}}))}videoRoomSwitch(e,t,i){return __awaiter(this,void 0,void 0,(function*(){try{if(0==t)throw new Error("invalid handle");let r={janus:"message",transaction:n(),body:{request:"switch",feed:i}};console.debug("[WebRTC] Switching subscription...",{message:r,handle:t});let o=yield this.sendJanusPluginRequest(e,t,r);return s(o),console.debug("[WebRTC] Switched Subscription",o.body),{}}catch(e){return{error:e}}}))}videoRoomConfigureRestart(e,t){return __awaiter(this,void 0,void 0,(function*(){try{if(0==t)throw new Error("invalid handle");let i={janus:"message",transaction:n(),body:{request:"configure",restart:!0}},r=yield this.sendJanusPluginRequest(e,t,i);return s(r),console.debug("[WebRTC] Sent Configure Restart request",r.body),{}}catch(e){return{error:e}}}))}startSubscribe(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){try{if("offer"!=i&&"answer"!=i)throw new Error("unsupported sdp type");let o={janus:"message",transaction:n(),body:{request:"start"},jsep:{type:i,sdp:r}},a=yield this.sendJanusPluginRequest(e,t,o);return s(a),console.debug("[WebRTC] Started subscriber feed",a.body),{}}catch(e){return{error:e}}}))}sendTrickleIce(e,t,i,r,o){return __awaiter(this,void 0,void 0,(function*(){try{let a={janus:"trickle",transaction:n(),candidate:{sdpMid:i,sdpMLineIndex:r,candidate:o}},d=yield this.sendJanusPluginRequest(e,t,a);return s(d),console.debug("[WebRTC] Sent ICE",d.body),{}}catch(e){return{error:e}}}))}sendTrickleIceCompleted(e,t){return __awaiter(this,void 0,void 0,(function*(){try{let i={janus:"trickle",transaction:n(),candidate:{completed:!0}},r=yield this.sendJanusPluginRequest(e,t,i);return s(r),console.log("[WebRTC] ICE Completed",r.body),{}}catch(e){return{error:e}}}))}publishToVideoRoom(e,t,i,r,o,a){return __awaiter(this,void 0,void 0,(function*(){try{if("offer"!=o&&"answer"!=o)throw new Error("sdp type unsupported");let d={type:o,sdp:a},c={janus:"message",transaction:n(),body:{request:"configure",audio:!!i,video:!!r},jsep:d},l=yield this.sendJanusPluginRequest(e,t,c);return s(l),console.debug("[WebRTC] publish request made",{request:c,response:l.body}),{}}catch(e){return{error:e}}}))}sendJanusSessionRequest(e,t){let n=`${this.janusBase}janus/${e}`;return this.sendJanusRequestPost(n,t)}sendJanusPluginRequest(e,t,n){let i=`${this.janusBase}janus/${e}/${t}`;return this.sendJanusRequestPost(i,n)}sendJanusRequestPost(e,t){return __awaiter(this,void 0,void 0,(function*(){if(!t.janus)throw new Error("The 'janus' property is not set in message");let n=this.prepareInit("post");n.body=JSON.stringify(t);let i=yield fetch(e,n),s=yield i.json();return{statusCode:i.status,body:s}}))}sendJanusRequestGet(e){return __awaiter(this,void 0,void 0,(function*(){let t=this.prepareInit("get"),n=yield fetch(e,t),i=yield n.json();return{statusCode:n.status,body:i}}))}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){function t(e){return!!e.startsWith("vrh")||(!!e.startsWith("observer")||!!e.startsWith("Controller"))}function n(e,t){return Array.isArray(e)?function(e){let t=document.createElement("table"),i=document.createElement("tbody");t.appendChild(i);for(let t of e){let[e,s]=n(t,!1),r=document.createElement("tr"),o=document.createElement("td");o.appendChild(e),o.title=s,r.appendChild(o),i.appendChild(r)}return[t]}(e):e instanceof Date?function(e){let t=(new Date).getTime(),n=e.getTime(),i=(t-n)/1e3;return[document.createTextNode(`${i}s ago`),e.toString()]}(e):e instanceof Map?function(e){let t=document.createElement("table");t.style.verticalAlign="top";let i=document.createElement("tbody");t.appendChild(i);for(let[t,s]of e.entries()){let e=document.createElement("tr"),r=document.createElement("th");r.innerText=t,r.style.verticalAlign="top",e.appendChild(r),i.appendChild(e);let[o,a]=n(s,!1),d=document.createElement("tr"),c=document.createElement("td");c.appendChild(o),c.title=a,d.appendChild(c),i.appendChild(d)}return[t]}(e):function(e){return"object"==typeof e&&!(!("id"in e)||"string"!=typeof e.id||!e.id.startsWith("RTC"))}(e)?function(e){let t=document.createElement("table");t.style.verticalAlign="top";let o=document.createElement("tbody");t.appendChild(o);let a=r[e.type];if(a&&!a(e))return[t];for(let t of Object.getOwnPropertyNames(e)){if(i.indexOf(t)>-1)continue;if(Array.isArray(s[e.type])&&s[e.type].indexOf(t)>-1)continue;let r=document.createElement("tr"),a=document.createElement("th");a.innerText=t,a.style.verticalAlign="top",r.appendChild(a);let d=e[t],c=document.createElement("td"),[l,h]=n(d,!1);c.appendChild(l),c.title=h,r.appendChild(c),o.appendChild(r)}return[t]}(e):"object"==typeof e?function(e){let t=document.createElement("table");t.style.verticalAlign="top";let i=document.createElement("tbody");t.appendChild(i);for(let t of Object.getOwnPropertyNames(e)){let s=document.createElement("tr"),r=document.createElement("th");r.innerText=t,r.style.verticalAlign="top",s.appendChild(r);let o=e[t],a=document.createElement("td"),[d,c]=n(o,!1);a.appendChild(d),a.title=c,s.appendChild(a),i.appendChild(s)}return[t]}(e):function(e,t){let n=void 0!==e?e.toString():"undefined";if(t){let e=document.createElement("span"),t=document.createElement("em");t.classList.add("vertex-webrtc-dimmed"),t.innerText="(Hidden)",e.appendChild(t);let i=document.createTextNode(n.substr(-4));return e.appendChild(i),[e]}return[document.createTextNode(n)]}(e,t)}e.WebRtcStatTracker=class{constructor(){this.displaySensitiveInfo=!1,this.displayAllRtcStats=!1,this.peerConnectionMonitors=new Map,this.scopes=new Map}getJsonSnapshot(){return JSON.stringify(this.scopes,this.jsonMapReplacer.bind(this),2)}downloadJsonSnapshot(){let e=new Blob([this.getJsonSnapshot()],{type:"application/json"}),t=URL.createObjectURL(e),n=(new Date).toISOString().replace(".","_").replace("/","_"),i=document.createElement("a");i.href=t,i.download=`webrtc_stats_${n}.json`,i.setAttribute("href",t),i.click()}jsonMapReplacer(e,t){return t instanceof Map?this.objectFromEntries(t):t}objectFromEntries(e){if(!e||!e[Symbol.iterator])throw new Error("Object.fromEntries() requires a single iterable argument");let t={};for(let[n,i]of e)t[n]=i;return t}set(e,n,i,s=!1){let r=this.scopes.get(e);r||(r={stats:new Map,visible:t(e)},this.scopes.set(e,r));let o=n.split(".");if(2==o.length){let e=r.stats.get(o[0]);e||(e={value:{},sensitive:!1,timestamp:new Date}),e.value[o[1]]||(e.value[o[1]]={}),e.value[o[1]]=i,e.timestamp=new Date,r.stats.set(o[0],e)}1===o.length&&r.stats.set(n,{value:i,sensitive:!!s,timestamp:new Date}),this.pendingRefresh=!0}increment(e,n,i=1){let s=this.scopes.get(e);s||(s={stats:new Map,visible:t(e)},this.scopes.set(e,s));let r=s.stats.get(n);r||(this.set(e,n,0),r=s.stats.get(n)),r.value=+r.value+i,r.timestamp=new Date,this.pendingRefresh=!0}trackPeerConnection(e,t,n){this.set(e,t,{pending:!0},!1);let i=setInterval((()=>__awaiter(this,void 0,void 0,(function*(){let t=yield n.getStats();const i=new Map,s=["certificate","codec","track","stream","peer-connection"];t.forEach((e=>{if(s.indexOf(e.type)>-1)return;let t=i.get(e.type);t||(t=[],i.set(e.type,t)),t.push(e)})),this.set(e,"rtcStats",i)}))),1e3);this.peerConnectionMonitors.set(n,i)}untrackPeerConnection(e){let t=this.peerConnectionMonitors.get(e);t&&clearInterval(t)}getScopeVisible(e){let t=this.scopes.get(e);return!!t&&t.visible}setScopeVisible(e,t){let n=this.scopes.get(e);n&&(n.visible=!!t,this.pendingRefresh=!0)}setWindowVisible(t){if(t){if(this.statsWindowElement||(this.statsWindowElement=this.createStatsWindowElement()),!document.querySelector(".vertex-webrtc-styles")){let t=e.createStatsCss();document.head.appendChild(t)}document.documentElement.appendChild(this.statsWindowElement),this.refreshIntervalHandle=setInterval((()=>{this.pendingRefresh&&this.refreshStatsDisplay()}),16),this.periodicRefreshHandle=setInterval((()=>{this.pendingRefresh=!0}),1e3)}else clearInterval(this.refreshIntervalHandle),clearInterval(this.periodicRefreshHandle),this.statsWindowElement&&(this.statsWindowElement.remove(),this.statsWindowElement=void 0)}createStatsWindowElement(){let e=document.createElement("div");e.classList.add("vertex-webrtc-stats-window");{let t=document.createElement("div");t.classList.add("vertex-webrtc-stats-window-header"),t.innerText="WebRTC Stats";{let e=document.createElement("input");e.type="checkbox",e.title="Reveal Sensitive Info",e.checked=!1,e.addEventListener("change",(()=>{this.displaySensitiveInfo=e.checked,this.pendingRefresh=!0}));let n=document.createElement("label");n.appendChild(e),n.appendChild(document.createTextNode("Show Sensitive Info")),n.style.cssFloat="right",t.appendChild(n)}{let e=document.createElement("input");e.type="checkbox",e.title="Show All RTC Info",e.checked=!1,e.addEventListener("change",(()=>{this.displayAllRtcStats=e.checked,this.pendingRefresh=!0}));let n=document.createElement("label");n.appendChild(e),n.appendChild(document.createTextNode("Show All RTC Info")),n.style.cssFloat="right",t.appendChild(n)}{let e=document.createElement("button");e.type="button",e.style.cssFloat="right",e.innerText="Save",e.addEventListener("click",(()=>{this.downloadJsonSnapshot()})),t.appendChild(e)}e.appendChild(t)}{let t=document.createElement("div");t.classList.add("vertex-webrtc-stats-window-body"),t.innerHTML="<em>There are no stats.</em>",e.appendChild(t)}return e}refreshStatsDisplay(){if(!this.statsWindowElement)return;this.pendingRefresh=!1;let e=this.statsWindowElement.querySelector(".vertex-webrtc-stats-window-body");for(;e.firstChild;)e.removeChild(e.firstChild);for(let[t,{stats:i,visible:s}]of this.scopes.entries()){let r=document.createElement("div");r.classList.add("vertex-webrtc-stats-scope"),r.dataset.webrtcStatScope=t;let o=document.createElement("table");o.style.verticalAlign="top",o.style.textAlign="left",o.style.width="100%",o.dataset.scopeName=t;{let e=document.createElement("thead");e.classList.add("vertex-webrtc-toggle","vertex-webrtc-toggle-inactive"),e.addEventListener("click",this.toggleBody.bind(this)),o.appendChild(e);let n=document.createElement("tr"),i=document.createElement("th");i.innerText=t,i.colSpan=2,n.appendChild(i),e.appendChild(n)}if(s){let e=document.createElement("tbody");o.appendChild(e);for(let[t,s]of i.entries()){if("rtcStats"===t&&!this.displayAllRtcStats)continue;let i=document.createElement("tr"),r=document.createElement("th");r.style.verticalAlign="top";let o=document.createElement("td");r.innerText=t;let a=s.sensitive&&!this.displaySensitiveInfo,[d,c]=n(s.value,a);o.appendChild(d),o.title=c,i.appendChild(r),i.appendChild(o),e.appendChild(i)}}r.appendChild(o),e.appendChild(r)}}toggleBody(e){let t=e.currentTarget.parentElement.dataset.scopeName,n=this.getScopeVisible(t);this.setScopeVisible(t,!n)}},e.createStatsCss=function(){let e=document.createElement("style");return e.classList.add("vertex-webrtc-styles"),e.innerHTML="\n.vertex-webrtc-stats-window {\n    color: black;\n    font-size: 0.8rem;\n    position: absolute;\n    top: 0;\n    right: 0;\n    min-width: 450px;\n    min-height: 200px;\n    border: 1px solid rgba(255, 255, 255, 0.75);\n    background: rgba(255, 255, 255, 0.666);\n    padding: 0.333rem;\n    margin: 1rem 2rem;\n    border-radius: 2px;\n    z-index: 1000;\n}\n\n.vertex-webrtc-stats-window-header {\n    /*cursor: move;*/\n    border: 1px solid rgba(255, 255, 255, 0.75);\n    background: rgba(255, 255, 255, 0.5);\n    padding: 0.333rem;\n    margin: -0.333rem -0.333rem 0.333rem;\n}\n\n.vertex-webrtc-stats-window-body {\n}\n.vertex-webrtc-stats-scope {\n    border-bottom: 1px solid black;\n}\n.vertex-webrtc-dimmed {\n    opacity: 50%;\n}\n\n.vertex-webrtc-toggle {\n    cursor: pointer;\n}\n\n.vertex-webrtc-toggle:hover {\n    text-decoration: underline;\n}\n",e};const i=["type","timestamp"],s={"media-source":["trackIdentifier","audioLevel","totalAudioEnergy","echoReturnLossEnhancement","echoReturnLoss","totalSamplesDuration"],"candidate-pair":["localCandidateId","remoteCandidateId","priority","transportId"],"inbound-rtp":[""],"outbound-rtp":["trackId","codecId","remoteSourceId","remoteId","transportId","mediaSourceId","firCount","pliCount","kind","framesEncoded","keyFramesEncoded","totalEncodeTime","totalEncodedBytesTarget","qpSum"],transport:["localCertificateId","remoteCertificateId","tlsVersion","dtlsCipher","srtpCipher","selectedCandidatePairChanges"]},r={"candidate-pair":e=>"waiting"!==e.state&&"in-progress"!==e.state}}(t=e.WebRtc||(e.WebRtc={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){class t{constructor(){this.handlers=new Map}add(e,t){if("function"!=typeof e)throw new Error("handler must be a function");this.handlers.set(e,t)}remove(e){this.handlers.delete(e)}invoke(e,t){this.handlers.forEach(((n,i)=>{n?i.call(n,e,t):i(e,t)}))}}e._WebRTCEvent=t;e.JanusSessionObserver=class{constructor(e,i){this.janus=e,this.cts=new n,this.stats=i,this.onError=new t,this.onKeepAlive=new t,this.onEvent=new t,this.onVideoRoomEvent=new t,this.onWebRtcUp=new t,this.onWebRtcMedia=new t,this.onWebRtcSlowLink=new t,this.onWebRtcHangup=new t,this.onEvent.add(this.self_onEvent,this)}observeSession(e,t,n){if(this.observing)throw new Error("already observing");this.spaceId=t,this.viewpointId=n,this.sessionId=e,this.observing=!0,this.stats.set("observer","keepAlive.sentAt","Never"),this.stats.set("observer","keepAlive.sendRtt",-1),this.stats.set("observer","keepAlive.receivedAt","Never"),this.stats.set("observer","lastMessage.time","Never"),this.stats.set("observer","lastMessage.type","none"),this.beginObserveSessionAndKeepAliveAsync()}destroy(){this.cts.cancel()}beginObserveSessionAndKeepAliveAsync(){return __awaiter(this,void 0,void 0,(function*(){try{for(;!this.cts.isCancellationRequested;)try{var e=yield this.janus.getSessionInfoAsync(this.sessionId);if(null!=e.error)throw e.error;this.cts.throwIfCancelled();var t=e.responseBody;if(!t)throw new Error("No response for session info, the session has probably closed.");this.stats.set("observer","lastMessage.time",new Date),this.stats.set("observer","lastMessage.type",t.janus);var n=t.janus;switch(n){case"keepalive":try{this.stats.set("observer","keepAlive.receivedAt",new Date),this.onKeepAlive.invoke(this,t)}catch(e){console.error(`[WebRTC] Unhandled Error while firing OnKeepAlive for session ${this.sessionId}:`,e)}break;case"event":try{this.onEvent.invoke(this,t)}catch(e){console.error(`[WebRTC] Unhandled Error while firing OnEvent for session ${this.sessionId}`,e)}break;case"webrtcup":try{this.onWebRtcUp.invoke(this,t)}catch(e){console.error(`[WebRTC] Unhandled error while firing OnWebRtcUp for session ${this.sessionId}`,e)}break;case"hangup":try{this.onWebRtcHangup.invoke(this,t)}catch(e){console.error(`[WebRTC] Unhandled error while firing OnWebRtcHangup for session ${this.sessionId}`,e)}break;case"media":try{this.onWebRtcMedia.invoke(this,t)}catch(e){console.error(`[WebRTC] Unhandled error while firing OnWebRtcMedia for session ${this.sessionId}`,e)}break;case"slowlink":try{this.onWebRtcSlowLink.invoke(this,t)}catch(e){console.error(`[WebRTC] Unhandled error while firing OnWebRtcSlowLink for session ${this.sessionId}`,e)}break;default:console.warn(`[WebRTC] Unknown Janus Event '${n}' received from server for ${this.sessionId}`,t)}}catch(e){return this.stats.set("observer","remoteError",new Date),console.error(`[WebRTC] Unhandled Error while observing session ${this.sessionId}:`,e),void this.onError.invoke(this,e)}finally{try{let e=(new Date).getTime();yield this.janus.sendVertexKeepAlive(this.spaceId,this.viewpointId,this.sessionId);let t=(new Date).getTime()-e;this.stats.set("observer","keepAlive.sendRtt",t),this.stats.set("observer","keepAlive.sentAt",new Date)}catch(e){return this.stats.set("observer","keepAliveError",new Date),console.error(`[WebRTC] Unhandled Error while sending KeepAlive for ${this.sessionId}: `,e),void this.onError.invoke(this,e)}}}finally{this.stats.set("observer","observerStopped",new Date)}}))}self_onEvent(e,t){let n=t.plugindata.plugin;if("janus.plugin.videoroom"===n)this.onVideoRoomEvent.invoke(this,t);else console.warn(`[WebRTC] Unknown plugin '${n}' received in event from server for ${this.sessionId}:`,t)}};e.TaskCompletionSource=class{constructor(){this._completed=!1;let e=this;this._promise=new Promise(((t,n)=>{e._resolver=t,e._rejecter=n}))}trySetResult(e){return this._resolver(e),this._completed=!0,!0}trySetException(e){return this._rejecter(e),this._completed=!0,!0}trySetCancelled(){return this._rejecter(new Error("Task was cancelled")),this._completed=!0,!0}get task(){return this._promise}get isCompleted(){return this._completed}};class n{constructor(){this.callbacks=new Set,this._cancellationPromise=new Promise((e=>{this._cancellationResolver=e})),this._cancelled=!1}get isCancellationRequested(){return this._cancelled}register(e){this.callbacks.add(e)}cancel(){if(!this._cancelled){this._cancelled=!0,this._cancellationResolver();for(let e of this.callbacks)e(this)}}throwIfCancelled(){if(this._cancelled)throw new Error("The CancellationToken was cancelled")}promise(){return this._cancellationPromise}static get none(){return this._noneInstance}static ensure(e){return e&&e instanceof n?e:this.none}}n._noneInstance=new n,e.CancellationTokenSource=n}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){e.DefaultWebRtcUserMediaFactory=class{constructor(){this.initialized=!1}initializeUserMediaAsync(e){return __awaiter(this,void 0,void 0,(function*(){try{try{if(!e.initAudio||!e.initVideo)throw new Error("Not initing audio+video because only audio or video was requested");yield this._initAV(),console.debug("[VERTX:WebRtc:initializeUserMedia] Successfully initialized Video and Audio devices")}catch(t){try{if(!e.initAudio)throw new Error("Not initing audio because audio was not requested");yield this._initA(),console.debug("[VERTX:WebRtc:initializeUserMedia] Successfully initialized Audio devices")}catch(n){try{if(!e.initVideo)throw new Error("Not initing video because video was not requested");yield this._initV(),console.debug("[VERTX:WebRtc:initializeUserMedia] Successfully initialized Video devices")}catch(e){throw console.debug("[VERTX:WebRtc:initializeUserMedia] Failed to initialize any media devices"),{errors:[t,n,e]}}}}}catch(e){throw console.error("[VERTX:WebRtc:initializeUserMedia] Failed to initialize any media devices"),e}finally{this.initialized=!0}}))}getCurrentMediaAsync(){return __awaiter(this,void 0,void 0,(function*(){if(!this.initialized)throw new Error("Must initialize before getting media");if(!this.userMediaStream)return[];let e=this.userMediaStream.getAudioTracks()||[],t=this.userMediaStream.getVideoTracks()||[];return e.concat(t)}))}releaseUserMediaAsync(){return __awaiter(this,void 0,void 0,(function*(){this.initialized=!1,this.userMediaStream.stop(),this.userMediaStream=null}))}_initAV(){return __awaiter(this,void 0,void 0,(function*(){this.userMediaStream=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}))}_initA(){return __awaiter(this,void 0,void 0,(function*(){this.userMediaStream=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}))}_initV(){return __awaiter(this,void 0,void 0,(function*(){this.userMediaStream=yield navigator.mediaDevices.getUserMedia({audio:!1,video:!0})}))}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){class t{}e.WebRtcComponentLifecycle=t;e.BaseWebRtcComponentView=class extends t{constructor(){super(...arguments),this.__dummyView=null}};e.BaseWebRtcComponentController=class extends t{constructor(){super(...arguments),this.__dummyController=null}};class n extends e.ComponentSystemBase{constructor(e,t,n,i){super(t,n,i),this.system=e}create(){return this.system.createComponent()}}e.WebRtcComponentSystem2Impl=n;class i extends e.ComponentViewBase{constructor(e,t){super(),this.viewObjects=new Map,this.viewType=t,this.system=e}addComponent(e,t){let n=e,i=new this.viewType;i.node=t,i.component=n,i.system=this.system,i.bindComponent(this.system,t,n),this.viewObjects.set(t.id,i)}removeComponent(e,t){let n=e,i=this.viewObjects.get(t.id);this.viewObjects.delete(t.id),i&&i.unbindComponent(this.system,t,n)}}e.WebRtcComponentView2Impl=i;class s extends e.ComponentControllerBase{constructor(e,t){super(),this.controllerObjects=new Map,this.controllerType=t,this.system=e}addComponent(e,t){let n=e,i=new this.controllerType;i.node=t,i.component=n,i.system=this.system,i.bindComponent(this.system,t,n),this.controllerObjects.set(t.id,i)}removeComponent(e,t){let n=e,i=this.controllerObjects.get(t.id);this.controllerObjects.delete(t.id),i&&i.unbindComponent(this.system,t,n)}}e.WebRtcComponentController2Impl=s}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(t){class n extends t.ComponentSystemBase{constructor(e,n,r){super(e=e||"WebRtc",n=n instanceof t.ComponentViewBase?n:new i,r=r instanceof t.ComponentControllerBase?r:new s)}create(){return new t.WebRtcComponent}}t.DefaultWebRtcComponentSystem=n;class i extends t.ComponentViewBase{constructor(){super(),i.injectAdapterJsSafe(),this.remoteMediaStreams=new Map}addComponent(e,n){return __awaiter(this,void 0,void 0,(function*(){let s=e;if(i._hintIfWebRtcNotInitiailized("DefaultWebRtcComponentView:addComponent"),yield i.isInitializedAsync,0==n.HasToken){let e=`${s.sndContext}-${s.rcvContext}`,i=yield s.createConnectionAsync(e,n.Space);i.peerConnection.addEventListener("track",(e=>this.peerConnection_onTrack.call(this,e,i,s,n))),i.peerConnection.addEventListener("removetrack",(e=>this.peerConnection_onRemoveTrack.call(this,e,i,s,n))),i.peerConnection.addEventListener("connectionstatechange",(e=>this.peerConnection_onConnectionStateChange.call(this,e,i,s,n)));let r=new t.WebRtcOnConnectArgs;r.rcvContext=s.rcvContext,s.onConnect.fire(s,r);let o=this.remoteMediaStreams.get(e);o||(o=this.createRemoteMediaStream(e,n))}}))}removeComponent(e,t){let n=e,i=n.getConnections();for(let e of i)this.destroyRemoteMediaStream(e.context,t);n.clearConnections()}createRemoteMediaStream(e,t){if(this.remoteMediaStreams.has(e))throw new Error(`[VERTX:DefaultWebRtcComponentView:createRemoteMediaStream] A media stream already exists for the context '${e}'`);let n=new MediaStream;this.remoteMediaStreams.set(e,n);let i={type:"created",context:e,stream:n};return t.event.fire("WebRtc:remotestreamchange",i),n}destroyRemoteMediaStream(e,t){let n=this.remoteMediaStreams.get(e);if(n){let t=n.getTracks();for(let e of t)n.removeTrack(e);this.remoteMediaStreams.delete(e)}let i={type:"destroyed",context:e,stream:n||null};t.event.fire("WebRtc:remotestreamchange",i)}peerConnection_onTrack(e,t,n,i){return __awaiter(this,void 0,void 0,(function*(){let n=this.remoteMediaStreams.get(t.context);n.addTrack(e.track);let s={type:"trackadded",context:t.context,stream:n,track:e.track};i.event.fire("WebRtc:remotestreamchange",s)}))}peerConnection_onRemoveTrack(e,t,n,i){let s=this.remoteMediaStreams.get(t.context);s.removeTrack(e.track);let r={type:"trackremoved",context:t.context,stream:s,track:e.track};i.event.fire("WebRtc:remotestreamchange",r)}peerConnection_onConnectionStateChange(e,t,n,i){"disconnected"===t.peerConnection.connectionState&&this.destroyRemoteMediaStream(t.context,i)}static initializeWebRtc(e){let t={mp3NoiseUrl:"/static/images/noise.mp3",oggNoiseUrl:"/static/images/noise.ogg"};Object.assign(t,e),this.initNoiseElement(t),i._initializeResolver(),i._isInitialized=!0}static uninitializeWebRtc(){i._isInitialized=!1,i.isInitializedAsync=new Promise((e=>{i._initializeResolver=e})),i._noiseElement&&(i._noiseElement.parentNode.removeChild(i._noiseElement),i._noiseElement=null),this.userMediaStream&&"function"==typeof this.userMediaStream.stop&&this.userMediaStream.stop(),this.userMediaStream=null,this.audioTracks=null,this.videoTracks=null}static getLocalMediaTracks(){let e=i.audioTracks||[],t=i.videoTracks||[];return e.concat(t)}static initializeLocalMediaDevicesAsync(){return __awaiter(this,void 0,void 0,(function*(){if(!(i.userMediaStream instanceof MediaStream))try{try{yield this.initializeAudioVideoDevicesAsync(),console.debug("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Successfully initialized Video and Audio devices")}catch(e){try{console.debug("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Could not initialize Video+Audio, trying Audio Only...",e),yield this.initializeAudioDevicesAsync(),console.debug("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Successfully initialized Audio device")}catch(t){try{console.debug("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Could not initialize Video+Audio or Audio, trying Video Only...",t),yield this.initializeVideoDevicesAsync(),console.debug("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Successfully initialized Video device")}catch(n){throw console.debug("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Could not initialize Video+Audio, Audio or Video. Failed device initialization.",t),{errors:[e,t,n]}}}}}catch(e){throw console.error("[VERTX:DefaultWebRtcComponentView:initializeMediaDevicesAsync] Failed to initialize media devices",e),e}}))}static initializeAudioVideoDevicesAsync(){return __awaiter(this,void 0,void 0,(function*(){i.userMediaStream=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),i.audioTracks=yield i.userMediaStream.getAudioTracks(),i.videoTracks=yield i.userMediaStream.getVideoTracks()}))}static initializeVideoDevicesAsync(){return __awaiter(this,void 0,void 0,(function*(){i.userMediaStream=yield navigator.mediaDevices.getUserMedia({audio:!1,video:!0}),i.audioTracks=[],i.videoTracks=yield i.userMediaStream.getVideoTracks()}))}static initializeAudioDevicesAsync(){return __awaiter(this,void 0,void 0,(function*(){i.userMediaStream=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),i.audioTracks=yield i.userMediaStream.getAudioTracks(),i.videoTracks=[]}))}static _fireLocalMediaEvent(e){if(i.userMediaStream){let t=this.getLocalMediaTracks(),n={type:"available",stream:i.userMediaStream,tracks:t};e.event.fire("WebRtc:localmediachange",n)}else{let t={type:"unavailable",stream:null,tracks:[]};e.event.fire("WebRtc:localmediachange",t)}}static disposeMediaDevicesAsync(){return __awaiter(this,void 0,void 0,(function*(){try{if(i.userMediaStream){let e=i.userMediaStream.getTracks();for(let t of e)t.stop();i.userMediaStream.stop(),i.userMediaStream=null}if(i.audioTracks){for(let e of i.audioTracks)e.stop();i.audioTracks=null}if(i.videoTracks){for(let e of i.videoTracks)e.stop();i.videoTracks=null}}catch(e){console.error("Failed to clean up old media devices",e)}}))}static initNoiseElement(e){if(!i._noiseElement){let e=document.createElement("audio");e.id="vertexDefaultWebRtcComponent_noiseElement",e.style.display="none",e.autoplay=!0,e.loop=!0,e.controls=!1,e.playsinline=!0,document.body.appendChild(e),i._noiseElement=e}for(let e of i._noiseElement.childNodes)e.parentNode.removeChild(e);let t=document.createElement("source");t.src=e.mp3NoiseUrl;let n=document.createElement("source");n.src=e.oggNoiseUrl,i._noiseElement.appendChild(t),i._noiseElement.appendChild(n);let s=i._noiseElement.play();if(s instanceof Promise){let e="[VERTX:DefaultWebRtcComponentView:initializeWebRtc] The WebRTC Background Noise could not be autoplayed.\nTry calling initializeWebRtc again as a result of direct user interaction (e.g. a mouse click).\nSome WebRTC elements may fail to autoplay without user interaction.";try{s.then((e=>{console.log("[VERTX:WebRtcComponentSystem:initializeWebRtc] Successfully started playing the WebRTC Background Noise. Autoplays should succeed reliably.")})).catch((t=>{console.error(e,t)}))}catch(t){console.error(e,t)}}}static injectAdapterJsSafe(){if(!window.adapter){let e=document.createElement("script");e.src="https://unpkg.com/webrtc-adapter@7.7.0/out/adapter.js",document.body.appendChild(e)}}static _hintIfWebRtcNotInitiailized(e){return __awaiter(this,void 0,void 0,(function*(){let t=new Promise((e=>{window.setTimeout(e,1e3,"timeout")}));"timeout"===(yield Promise.race([t,i.isInitializedAsync]))&&console.warn(`[VERTX:${e}] HINT: Waiting for WebRtcComponentView to be initialized.\nYou must call the static 'WebRtcComponentView.initializeWebRtc()' method before incoming or outgoing WebRTC connections can be made.\n\nThe pending WebRTC call will continue once initialize has been called.`)}))}}i.userMediaStream=null,i.audioTracks=null,i.videoTracks=null,i._noiseElement=null,i._initializeResolver=null,i._isInitialized=!1,i.isInitializedAsync=new Promise((e=>{i._initializeResolver=e})),t.DefaultWebRtcComponentView=i;class s extends t.ComponentControllerBase{constructor(){super(...arguments),this.componentChangedHandlers=new Map}addComponent(e,t){return __awaiter(this,void 0,void 0,(function*(){let n=e,s=this.component_changed.bind(this);this.componentChangedHandlers.set(e,s),n.onChanged.on(s),i._hintIfWebRtcNotInitiailized("DefaultWebRtcComponentController:addComponent");let r=i.initializeLocalMediaDevicesAsync();n.onConnect.on((e=>this.component_onConnect.call(this,e,n,t,r))),yield i.isInitializedAsync,r.then((()=>{i._fireLocalMediaEvent(t)})).catch((()=>{i._fireLocalMediaEvent(t)}))}))}removeComponent(e,t){let n=e;if(this.componentChangedHandlers.has(e)){let t=this.componentChangedHandlers.get(e);this.componentChangedHandlers.delete(e),n.onChanged.off(t)}!0===t.HasToken&&(i.uninitializeWebRtc(),i._fireLocalMediaEvent(t))}component_changed(e){let t=e;this.setTracksEnabled(t)}setTracksEnabled(e){let t=i.audioTracks||[];for(var n of t)n.enabled=e.audio;let s=i.videoTracks||[];for(var n of s)n.enabled=e.video}component_onConnect(e,t,n,s){return __awaiter(this,void 0,void 0,(function*(){console.log("[VERTX:WebRtcComponentController:onConnect] onConnect fired, handling peer connection once media devices are ready"),yield s,console.log("[VERTX:WebRtcComponentController:onConnect] media devices are ready. handling peer connection");let r=`${t.sndContext}-${e.rcvContext}`;if(!0===n.HasToken){this.setTracksEnabled(t);let e=yield t.createConnectionAsync(r,n.Space),s=yield i.getLocalMediaTracks();yield e.addTracks(s)}}))}}t.DefaultWebRtcComponentController=s;class r{constructor(t,n){this.context=null,this.signaler=null,this.peerConnection=null,this.offerSdpFragBuf="",this.offerSdpSeq=-1,this.answerSdpFragBuf="",this.answerSdpSeq=-1,this.context=t,this.signaler=new e.DataChannel(n),this.signaler.id=t}initAsync(){return __awaiter(this,void 0,void 0,(function*(){this.signaler.onMessage.on(this.signaler_onMessage.bind(this)),yield this.signaler.init();let e={iceServers:r.defaultIceServers};this.peerConnection=new RTCPeerConnection(e),this.peerConnection.addEventListener("connectionstatechange",this.peerConnection_onConnectionStateChange.bind(this)),this.peerConnection.addEventListener("icecandidate",this.peerConnection_onIceCandidate.bind(this)),this.peerConnection.addEventListener("negotiationneeded",this.peerConnection_negotiationNeeded.bind(this))}))}addTracks(e){return __awaiter(this,void 0,void 0,(function*(){for(let t of e)this.peerConnection.addTrack(t)}))}sendOfferFragmentedAsync(){return __awaiter(this,void 0,void 0,(function*(){let e=yield this.peerConnection.createOffer();yield this.peerConnection.setLocalDescription(e);const t=3072;let n=Math.floor(e.sdp.length/t)+1;for(let i=0;i<n;++i){let s=e.sdp.substr(t*i,t),r=i==n-1,o={type:"fragmented-offer",seq:i,last:r,sdpFragment:s},a=JSON.stringify(o);console.log("Sending Offer Fragment",{length:a.length,seq:i,reqd:n,frag:s,last:r,message:a}),yield this.signaler.sendMessage(a)}}))}sendAnswerFragmentedAsync(){return __awaiter(this,void 0,void 0,(function*(){let e=yield this.peerConnection.createAnswer();yield this.peerConnection.setLocalDescription(e);const t=3072;let n=Math.floor(e.sdp.length/t)+1;for(let i=0;i<n;++i){let s=e.sdp.substr(t*i,t),r=i==n-1,o={type:"fragmented-answer",seq:i,last:r,sdpFragment:s},a=JSON.stringify(o);console.log("Sending Answer Fragment",{length:a.length,seq:i,reqd:n,frag:s,last:r,message:a}),yield this.signaler.sendMessage(a)}}))}close(){this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}resetOfferSdpFragState(){this.offerSdpFragBuf="",this.offerSdpSeq=-1}resetAnswerSdpFragState(){this.answerSdpFragBuf="",this.answerSdpSeq=-1}signaler_onMessage(e){return __awaiter(this,void 0,void 0,(function*(){try{let t=JSON.parse(e);if("fragmented-offer"===t.type){console.debug("[VERTX:WebRtcConnection:onSignalMessage] Offer Fragment Received",{message:t});let e=t;if(this.offerSdpSeq+1!=e.seq)return console.error("[VERTX:WebRtcConnection:onSignalMessage] Received out-of-sequence offer fragment, discarding current sequence. ",{expectedSeqNumber:this.offerSdpSeq+1,receivedSeqNumber:e.seq,equal:this.offerSdpSeq+1==e.seq}),void this.resetOfferSdpFragState();if(this.offerSdpSeq=e.seq,this.offerSdpFragBuf+=t.sdpFragment,t.last){let e={type:"offer",message:{sdp:this.offerSdpFragBuf,type:"offer"}},t=JSON.stringify(e);this.resetOfferSdpFragState(),yield this.signaler_onMessage(t)}}if("fragmented-answer"===t.type){console.debug("[VERTX:WebRtcConnection:onSignalMessage] Answer Fragment Received",{message:t});let e=t;if(this.answerSdpSeq+1!=e.seq)return console.error("[VERTX:WebRtcConnection:onSignalMessage] Received out-of-sequence answer fragment, discarding current sequence. ",{expectedSeqNumber:this.answerSdpSeq+1,receivedSeqNumber:e.seq,equal:this.answerSdpSeq+1==e.seq}),void this.resetAnswerSdpFragState();if(this.answerSdpSeq=e.seq,this.answerSdpFragBuf+=t.sdpFragment,t.last){let e={type:"answer",message:{sdp:this.answerSdpFragBuf,type:"answer"}},t=JSON.stringify(e);this.resetAnswerSdpFragState(),yield this.signaler_onMessage(t)}}if("offer"===t.type){console.debug("[VERTX:WebRtcConnection:onSignalMessage] Offer Received",{message:t});let e=t;try{yield this.peerConnection.setRemoteDescription({type:"offer",sdp:e.message.sdp})}catch(e){console.warn("[VERTX:WebRtcConnection:onSignalMessage] Failed to set remote description (handling offer)",{error:e,sdp:t.message})}yield this.sendAnswerFragmentedAsync()}if("answer"===t.type){console.debug("[VERTX:WebRtcConnection:onSignalMessage] Answer Received",{message:t});let e=t;try{yield this.peerConnection.setRemoteDescription({type:"answer",sdp:e.message.sdp})}catch(e){console.warn("[VERTX:WebRtcConnection:onSignalMessage] Failed to set remote description (handling answer)",{error:e,sdp:t.message})}}if("ice"===t.type){let e=t;console.debug("[VERTX:WebRtcConnection:onSignalMessage] ICE Candidate Received",{message:t});let n=e.message.content;try{if(n&&n.length>0){let t={candidate:e.message.content,sdpMid:e.message.sdpMid,sdpMLineIndex:e.message.sdpMlineIndex};yield this.peerConnection.addIceCandidate(t)}else console.warn("[VERTX:WebRtcConnection:onSignalMessage] Received null ICE candidate. This will be ignored, but the sending WebRTC implementation should take care not to send empty ICE candidates!",{message:t})}catch(e){console.warn("[VERTX:WebRtcConnection:onSignalMessage] Failed to add ICE candidate",{error:e,candidate:t.message})}}}catch(e){throw e}}))}peerConnection_onConnectionStateChange(e){console.debug(`[VERTX:WebRtcConnection:onConnecionStateChange] Connection State is now ${this.peerConnection.connectionState}`)}peerConnection_onIceCandidate(e){return __awaiter(this,void 0,void 0,(function*(){let t=e.candidate;if(t&&t.candidate.length>0){let e={type:"ice",message:{content:t.candidate,sdpMid:t.sdpMid,sdpMlineIndex:t.sdpMLineIndex}};yield this.signaler.sendMessage(JSON.stringify(e))}}))}peerConnection_negotiationNeeded(e){return __awaiter(this,void 0,void 0,(function*(){let t=e.target;console.log("[WebRtcConnection] [Re]negotiation Needed, creating and sending SDP...",{peerConnection:t}),yield this.sendOfferFragmentedAsync()}))}}r.defaultIceServers=[{urls:"stun:public.stun.vertx.cloud:3478"},{urls:"turn:public.turn.vertx.cloud:3478",username:"visr",credential:"visr",credentialType:"password"}],t.WebRtcConnection=r}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(t){class n extends t.Component{constructor(){super(),this.sndContext="null",this.isActive=!1,this.video=!1,this.audio=!1,this.callId="",this.connections=new Map,this.rcvContext="null",this.sndContext=e.Guid.NewGuid(),this.callId="",this.isActive=!1,this.video=!1,this.audio=!1,this.onConnect=new t.RPCEventBus("OnConnect",i),this.events.set(this.onConnect.eventName,this.onConnect),this.rcvContext=e.Guid.NewGuid()}writeData(e,t){super.writeData(e,t),e.setDebugState("[WebRtcComponent]",this),e.writeString(this.sndContext),e.writeBool(this.isActive),e.writeBool(this.video),e.writeBool(this.audio)}readData(e){super.readData(e),e.setDebugState("[WebRtcComponent]",this),this.sndContext=e.readString(),this.isActive=e.readBool(),this.video=e.readBool(),this.audio=e.readBool()}bsonReadAction(e,t,n){"SndContext"!==e?"IsActive"!==e?"Video"!==e?"Audio"!==e?"CallId"===e&&n.readString(this,"callId"):n.readBoolean(this,"audio"):n.readBoolean(this,"video"):n.readBoolean(this,"isActive"):n.readString(this,"sndContext")}readDataBSON(e){e.readObject(this.bsonReadAction.bind(this))}writeDataBSON(e){let t=e.startObject();e.writeString("SndContext",this.sndContext),e.writeString("CallId",this.callId),e.writeBoolean("IsActive",this.isActive),e.writeBoolean("Video",this.video),e.writeBoolean("Audio",this.audio),e.endObject(t)}createConnectionAsync(e,n){return __awaiter(this,void 0,void 0,(function*(){if(this.connections.has("context"))throw new Error(`[VERTX:WebRtcComponent:createConnectionAsync] A connection already exists with context '${e}'.`);let i=new t.WebRtcConnection(e,n);return yield i.initAsync(),this.connections.set(e,i),i}))}getConnection(e){return this.connections.get(e)}getConnections(){return this.connections.values()}clearConnections(){for(let e of this.connections.values())e.close();this.connections.clear()}}t.WebRtcComponent=n;class i extends t.Structure{constructor(){super(),this.rcvContext="null",this.rcvContext=""}writeData(e,t){super.writeData(e,t),e.setDebugState("[WebRtcOnConnectArgs]",this),e.writeString(this.rcvContext)}readData(e){super.readData(e),e.setDebugState("[WebRtcOnConnectArgs]",this),this.rcvContext=e.readString()}bsonReadAction(e,t,n){"RcvContext"!==e||n.readString(this,"rcvContext")}readDataBSON(e){e.readObject(this.bsonReadAction.bind(this))}writeDataBSON(e){let t=e.startObject();e.writeString("RcvContext",this.rcvContext),e.endObject(t)}}function s(e,t){if(!e){let e=new Error;console.error(`WebRTC Assertion Failed: ${t||"<no message>"}`,{message:t,stack:e.stack})}}t.WebRtcOnConnectArgs=i;class r{constructor(){this.iceServers=[{urls:"stun:public.stun.vertx.cloud:3478"},{urls:"turn:public.turn.vertx.cloud:3478",username:"visr",credential:"visr",credentialType:"password"}],this.remoteAudioEnabled=!0,this.remoteVideoEnabled=!0,this.localAudioEnabled=!0,this.localVideoEnabled=!0,this.mp3noiseurl="/static/images/noise.mp3",this.oggnoiseurl="/static/images/noise.ogg",this.useDebugVp8Room=!1,this.useDebugH264Room=!1,this.initTcs=null,this.sessionInfo=null,this.janus=null,this.sessionObserver=null,this.janusVrHandlePublisher=null,this._publisherId=0,this.localPublisherIdChanged=new t._WebRTCEvent,this.peerConnectionsByVideoRoomHandle=new Map,this.userMediaStream=null,this._callId="",this._currentSpaceId="",this.onresize_logScreenSize=()=>{this.statTracker.set("system","screenSize",`${screen.width}x${screen.height}@${window.devicePixelRatio}`)},r._singletonInstance||(r._singletonInstance=this),this.initTcs=new t.TaskCompletionSource,this.statTracker||(this.statTracker=new e.WebRtc.WebRtcStatTracker),this.onWebRtcInitialized=new e.EventBus,this.onWebRtcUninitialized=new e.EventBus,this.userMediaFactory=new t.DefaultWebRtcUserMediaFactory}get publisherId(){return this._publisherId}get callId(){return this._callId}set callId(e){if(this.isInitialized)throw new Error("callId cannot be changed while WebRTC is initialized. Uninitialize WebRTC (and await shutdown) before changing callId.");this._callId=e&&e.toLowerCase()||""}get spaceId(){return this._currentSpaceId}createSystem(){let e=new t.WebRtcComponentView2Impl(this,o),n=new t.WebRtcComponentController2Impl(this,a);return new t.WebRtcComponentSystem2Impl(this,"WebRtc",e,n)}createComponent(){return new n}static getInstance(){return this._singletonInstance}initializeWebRtc(){return __awaiter(this,void 0,void 0,(function*(){this.checkForWebRtcAdapter(),this.statTracker.set("system","initialized",!0),this.initNoiseElement();let n=e.Globals.runtime.space,i=n.id;this._currentSpaceId=i;let s=n.spaceLink.client.ViewpointId,r=e.Globals.bearerToken;if(this.callId&&(this.statTracker.set("system","vertexIds.originalSpaceId",i,!0),this.statTracker.set("system","vertexIds.usingCustomCallId","true",!0),console.log(`[WebRtcComponentSystem] CallId is set: connecting to ${this.callId} instead of ${i}`),i=this.callId),window.addEventListener("resize",this.onresize_logScreenSize),this.onresize_logScreenSize(),this.statTracker.set("system","uaString",navigator.userAgent),this.statTracker.set("system","vertexIds.stack",e.Globals.vertexStackUrl),this.statTracker.set("system","vertexIds.spaceId",i,!0),this.statTracker.set("system","vertexIds.viewpointId",s,!0),this.janus=new t.JanusApi(`https://${e.Globals.vertexStackUrl}/`),r)this.janus.setBearerToken(r);else{if(!("vertx.cloud"===location.hostname||location.hostname.endsWith(".vertx.cloud")))throw new Error("You must set Vertex.Globals.bearerToken to use WebRTC")}if(!i||!s)throw new Error("Init failed. Maybe you're not connected to the space yet? (Space or Viewpoint ID is not set, or not authenticated)");if(this.useDebugVp8Room&&(this.statTracker.set("system","debug.forceVp8Room",!0),console.warn("[WebRtcComponentSystem] DEBUG: Force joining room VP8 Test Room")),this.useDebugH264Room&&(this.statTracker.set("system","debug.forceH264Room",!0),console.warn("[WebRtcComponentSystem] DEBUG: Force joining room H264 Test Room")),this.statTracker.set("system","vertexIds.sessionId","pending"),this.statTracker.set("system","vertexIds.roomId","pending"),this.sessionInfo=yield this.janus.createVertexWebRtcSessionAsync(i,s,this.useDebugVp8Room,this.useDebugH264Room),null==this.sessionInfo)throw this.statTracker.set("system","vertexIds.sessionId","Failed!!"),this.statTracker.set("system","vertexIds.roomId","Failed!!"),new Error("Init failed. Failed to create session. Try again later.");this.statTracker.set("system","vertexIds.sessionId",this.sessionInfo.jSession,!0),this.statTracker.set("system","vertexIds.roomId",this.sessionInfo.roomId,!0);let o=new t.JanusSessionObserver(this.janus,this.statTracker);o.onError.add(this.observer_onError,this),o.onKeepAlive.add(this.observer_onKeepAlive,this),o.onEvent.add(this.observer_onEvent,this),o.onVideoRoomEvent.add(this.observer_onVideoRoomEvent,this),o.onWebRtcUp.add(this.observer_onWebRtcUp,this),o.onWebRtcHangup.add(this.observer_onWebRtcHangup,this),o.onWebRtcMedia.add(this.observer_onWebRtcMedia,this),o.onWebRtcSlowLink.add(this.observer_onWebRtcSlowLink,this),o.observeSession(this.sessionInfo.jSession,i,s),this.sessionObserver=o,this.statTracker.set("system","vertexIds.publishHandle","Pending");var a=yield this.janus.createVideoRoomPluginHandle(this.sessionInfo.jSession);if(a.error)throw this.statTracker.set("system","vertexIds.publishHandle","Failed!"),console.error("vrResult error",a.error),new Error("Init failed. Couldn't join VideoRoom as Publisher");this.statTracker.set("system","vertexIds.publishHandle",a.handle,!0),this.janusVrHandlePublisher=a.handle,this.statTracker.set("system","publishJoined","Pending");for(let e=0;e<3;++e)this.statTracker.set("system","publishJoined",`FlushingMessages: ${e+1} of 3`),yield this.janus.leaveVideoRoom(this.sessionInfo.jSession,this.janusVrHandlePublisher);this.statTracker.set("system","publishJoined","Joining");var d=yield this.janus.joinVideoRoomAsPublisher(this.sessionInfo.jSession,this.janusVrHandlePublisher,this.sessionInfo.roomId,"Web User");if(d.error)throw console.error("joinResult error",d.error),new Error("Init failed. Couldn't join VideoRoom as Publisher");this.statTracker.set("system","publishJoined",!d.error),this.initTcs.trySetResult(),this.onWebRtcInitialized.trigger({sender:this})}))}setPeerConnectionForHandle(e,t){t?this.peerConnectionsByVideoRoomHandle.set(e,t):this.peerConnectionsByVideoRoomHandle.delete(e)}getVideoRoomPublishHandle(){return this.janusVrHandlePublisher}createVideoRoomHandle(){return __awaiter(this,void 0,void 0,(function*(){let e=yield this.janus.createVideoRoomPluginHandle(this.sessionInfo.jSession);if(e.error)throw e.error;return e.handle}))}destroyVideoRoomHandle(e){return __awaiter(this,void 0,void 0,(function*(){let t=yield this.janus.detachPluginHandle(this.sessionInfo.jSession,e);if(t.error)throw t.error}))}setStatsWindowVisible(e){this.statTracker.setWindowVisible(e)}subscribeTo(e,t){return __awaiter(this,void 0,void 0,(function*(){if(console.debug("[WebRTC] Subscribing with settings ",{audioEnabled:this.remoteAudioEnabled,videoEnabled:this.remoteVideoEnabled}),0==e)throw new Error("Invalid Handle");let n=yield this.janus.videoRoomSubscribe(this.sessionInfo.jSession,e,t,this.sessionInfo.roomId,this.remoteAudioEnabled,this.remoteVideoEnabled);if(n.error)throw n.error}))}unsubscribeFrom(e,t){return __awaiter(this,void 0,void 0,(function*(){if(0==e)throw new Error("Invalid Handle");let t=yield this.janus.leaveVideoRoom(this.sessionInfo.jSession,e);if(t.error)throw t.error}))}switchSubscriptionTo(e,t){return __awaiter(this,void 0,void 0,(function*(){if(console.debug("[WebRTC] Switching to new publisher "+t),0==e)throw new Error("Invalid Handle");let n=yield this.janus.videoRoomSwitch(this.sessionInfo.jSession,e,t);if(n.error)throw n.error;let i=yield this.janus.videoRoomConfigureRestart(this.sessionInfo.jSession,e);if(i.error)throw i.error}))}sendJsep(e,t,n){return __awaiter(this,void 0,void 0,(function*(){e===this.janusVrHandlePublisher?yield this.janus.publishToVideoRoom(this.sessionInfo.jSession,e,this.localAudioEnabled,this.localVideoEnabled,t,n):yield this.janus.startSubscribe(this.sessionInfo.jSession,e,t,n)}))}sendIce(e,t,n,i){return __awaiter(this,void 0,void 0,(function*(){yield this.janus.sendTrickleIce(this.sessionInfo.jSession,e,t,n,i)}))}sendIceComplete(e){return __awaiter(this,void 0,void 0,(function*(){yield this.janus.sendTrickleIceCompleted(this.sessionInfo.jSession,e)}))}observer_onKeepAlive(e,t){}observer_onEvent(e,t){console.debug("[WebRTC] Janus Event",t)}observer_onWebRtcUp(e,t){console.log("[WebRTC] WebRTC Up! (Janus connection established)",t),this.statTracker.set(`vrh${t.sender}`,"backchannel.status","WebRtcUp"),this.statTracker.set(`vrh${t.sender}`,"backchannel.statusTime",new Date)}observer_onWebRtcHangup(e,t){console.warn("[WebRTC] WebRTC Hangup! (Janus WebRTC connection ended)",t),this.statTracker.set(`vrh${t.sender}`,"backchannel.status",`WebRtcHangup Reason: ${t.reason}`),this.statTracker.set(`vrh${t.sender}`,"backchannel.statusTime",new Date)}observer_onWebRtcMedia(e,t){this.statTracker.set(`vrh${t.sender}`,`media_${t.type}.serverReceiving`,t.receiving),t.receiving?console.debug(`[WebRTC] Janus is now receiving ${t.type} (vrh ${t.sender})`,t):console.warn(`[WebRTC] Janus is no longer receiving ${t.type} (vrh ${t.sender})`,t)}observer_onWebRtcSlowLink(e,t){let n=t.uplink?"up":"down";this.statTracker.set(`vrh${t.sender}`,`slowlink_${n}`,t.nacks),this.statTracker.increment(`vrh${t.sender}`,`slowlink_${n}_total`,t.nacks),console.log(`[WebRTC] Slow ${n}link - ${t.nacks} nacks`,t)}observer_onVideoRoomEvent(e,t){return __awaiter(this,void 0,void 0,(function*(){let e=t.plugindata.data,n=e.videoroom;if("event"==n&&"ok"===e.configured){let n=e.audio_codec||"unknown",i=e.video_codec||"unknown";console.debug(`[WebRTC] Video Room Reconfigured. Using codecs ${i}/${n}. Handling JSEP...`,t);let s=t.sender,r=this.peerConnectionsByVideoRoomHandle.get(s);if(r||console.error("[WebRTC] Received configure for a peerconnection we haven't set up yet!"),t.jsep){if(yield r.setRemoteDescription({type:t.jsep.type,sdp:t.jsep.sdp}),"offer"==t.jsep.type){let e=yield r.createAnswer();console.log("Sending answer",e),yield r.setLocalDescription(e),yield this.sendJsep(s,e.type,e.sdp)}}else console.error("[WebRTC] Expected JSEP with 'configured' event!")}if("joined"==n){let t=e.room,n=e.description||"<no description>",i=e.id;this._publisherId=i,this.localPublisherIdChanged.invoke(this,this._publisherId),console.log(`[WebRTC] Joined Room ${t} (${n}) successfully! Our publisher ID is ${i}`)}if("attached"==n){let n=e.room,s=e.id,r=e.display||"<no name>";if(s==this.publisherId)return void console.log(`Not subscribing to ${s} (${r}) because that's our own stream`);console.debug(`[WebRTC] Subscribing to ${s} (${r}) in room ${n}...`);let o=t.sender,a=this.peerConnectionsByVideoRoomHandle.get(o);if(a){var i=t.jsep;console.debug(`[WebRTC] Applying incoming SDP for ${s}`,i),yield a.setRemoteDescription({type:i.type,sdp:i.sdp});let e=yield a.createAnswer();console.debug(`[WebRTC] Sending asnwer for ${s}`,e),yield a.setLocalDescription(e),yield this.sendJsep(o,e.type,e.sdp)}else console.error(`[WebRTC] No peer connection registered for ${s}`)}}))}observer_onError(e,t){console.error("Observer Error",t)}uninitializeWebRtc(){return __awaiter(this,void 0,void 0,(function*(){this.initTcs.trySetCancelled(),this.initTcs=new t.TaskCompletionSource,yield this.janus.leaveVideoRoom(this.sessionInfo.jSession,this.janusVrHandlePublisher);try{yield this.janus.detachPluginHandle(this.sessionInfo.jSession,this.janusVrHandlePublisher)}catch(e){}this.janusVrHandlePublisher=0,this._publisherId=0,this.localPublisherIdChanged.invoke(this,this.publisherId);for(let[e,t]of this.peerConnectionsByVideoRoomHandle.entries())s(!t,`The PeerConnection for ${e} has not been destroyed. Destroying now.`),t&&t.close();this.peerConnectionsByVideoRoomHandle.clear(),this.sessionObserver&&(this.sessionObserver.destroy(),this.sessionObserver=null),this.sessionInfo=null,this.janus=null,this.onWebRtcUninitialized.trigger({sender:this})}))}isInitializedAsyncTask(){return __awaiter(this,void 0,void 0,(function*(){return this.initTcs.task}))}get isInitialized(){return this.initTcs.isCompleted}initNoiseElement(){if(!this.noiseElement){let e=document.createElement("audio");e.id="vertexDefaultWebRtcComponent_noiseElement",e.style.display="none",e.autoplay=!0,e.loop=!0,e.controls=!1,e.playsinline=!0,e.playsInline=!0,document.body.appendChild(e),this.noiseElement=e}for(let e of this.noiseElement.childNodes)e.parentNode.removeChild(e);let e=document.createElement("source");e.src=this.mp3noiseurl;let t=document.createElement("source");t.src=this.oggnoiseurl,this.noiseElement.appendChild(e),this.noiseElement.appendChild(t);let n=this.noiseElement.play();if(n instanceof Promise){let e="[VERTX:DefaultWebRtcComponentView:initializeWebRtc] The WebRTC Background Noise could not be autoplayed.\nTry calling initializeWebRtc again as a result of direct user interaction (e.g. a mouse click).\nSome WebRTC elements may fail to autoplay without user interaction.";try{n.then((e=>{console.log("[VERTX:WebRtcComponentSystem:initializeWebRtc] Successfully started playing the WebRTC Background Noise. Autoplays should succeed reliably.")})).catch((t=>{console.error(e,t)}))}catch(t){console.error(e,t)}}}checkForWebRtcAdapter(){if(!window.adapter){let t=["vertx.cloud","nx-staging.vertx.cloud","dev.vertx.cloud"];if(t.indexOf(location.host)>=0){let e=document.createElement("script");e.src="/runtime/js/webrtc-adapter/adapter.js",document.body.appendChild(e)}else if(e.Globals.vertexStackUrl)try{let n=new URL(e.Globals.vertexStackUrl);if(!(t.indexOf(n.host)>=0))throw new Error("invalid stack url");{console.error("[WebRtcComponentSystem.initializeWebRtc] WebRTC Adapter (adapter.js) has not been loaded.\nTo maximize WebRTC compatibility, adapter.js should be loaded before init. adapter is available from npm at 'webrtc-adapter', with a version of at least 7.7.0\n\nAdapter will automatically be loaded from VERTX, but this behaviour will be removed in the future.");let e=document.createElement("script");e.src=`https://${n.host}/runtime/js/webrtc-adapter/adapter.js`,document.body.appendChild(e)}}catch(e){console.error("[WebRtcComponentSystem.initializeWebRtc] WebRTC Adapter (adapter.js) has not been loaded.\nTo maximize WebRTC compatibility, adapter.js should be loaded before WebRTC init. The 'webrtc-adapter' package is available on NPM, and should be loaded with a version of at least 7.7.0")}else console.error("[WebRtcComponentSystem.initializeWebRtc] WebRTC Adapter (adapter.js) has not been loaded.\nTo maximize WebRTC compatibility, adapter.js should be loaded before WebRTC init. The 'webrtc-adapter' package is available on NPM, and should be loaded with a version of at least 7.7.0")}}}r._singletonInstance=null,t.WebRtcComponentSystem2=r;class o extends t.BaseWebRtcComponentView{constructor(){super(...arguments),this.initTcs=new t.CancellationTokenSource,this.subscriberHandle=Promise.resolve(0),this.currentSubscriptionId=0,this.currentSubscriptionInfo=null,this._hasSubscribedToAny=!1}isValidCall(){let e=this.component.callId.toLowerCase();return e||(e=this.system.spaceId),this.system.statTracker.set(`View ${this.node.id}`,"callId",e,!1),e!=this.system.callId?(this.system.statTracker.set(`View ${this.node.id}`,"ignored","yes: callId does not match",!1),!1):(this.system.statTracker.set(`View ${this.node.id}`,"ignored","no: callId matches",!1),!0)}bindComponent(e,t,n){this.system.statTracker.set(`View ${t.id}`,"bound",!0),this.changeHandler=this.component_onChanged.bind(this),n.onChanged.on(this.changeHandler),this.initHandler=this.system_onWebRtcInitialized.bind(this),e.onWebRtcInitialized.on(this.initHandler),this.uninitHandler=this.system_onWebRtcUninitialized.bind(this),e.onWebRtcUninitialized.on(this.uninitHandler),e.isInitialized&&this.startWebRtcAsync(this.initTcs).catch(this.logErrors)}unbindComponent(e,t,n){this.system.statTracker.set(`View ${t.id}`,"bound",!1),this.changeHandler&&n.onChanged.off(this.changeHandler),this.changeHandler=null,this.initHandler&&e.onWebRtcInitialized.off(this.initHandler),this.initHandler=null,this.uninitHandler&&e.onWebRtcUninitialized.off(this.uninitHandler),this.uninitHandler=null,this.initTcs.cancel(),this.stopWebRtcAsync().catch(this.logErrors)}system_onWebRtcInitialized(e){this.startWebRtcAsync().catch(this.logErrors)}system_onWebRtcUninitialized(e){this.stopWebRtcAsync().catch(this.logErrors)}component_onChanged(e){return __awaiter(this,void 0,void 0,(function*(){let t=e;var n=t.sndContext;console.debug(`[WebRTC] WebRtcComponent Changed: Context: ${n}, Audio: ${t.audio}, Video: ${t.video}`);let i=this.parseHandle(n);this.currentSubscriptionId=i,this.system.statTracker.set(`View ${this.node.id}`,"subscriptionId",this.currentSubscriptionId,!0),this.updateSubscriptionState()}))}startWebRtcAsync(e){return __awaiter(this,void 0,void 0,(function*(){if(e=t.CancellationTokenSource.ensure(e),this.system.statTracker.set(`View ${this.node.id}`,"callId",this.component.callId,!0),!this.isValidCall())return;this.subscriberHandle=this.system.createVideoRoomHandle(),yield this.subscriberHandle,this._hasSubscribedToAny=!1;let n=this.parseHandle(this.component.sndContext);this.currentSubscriptionId=n,this.updateSubscriptionState()}))}stopWebRtcAsync(e,n){return __awaiter(this,void 0,void 0,(function*(){if(n=t.CancellationTokenSource.ensure(n),!e){let e=this;this.subscriberHandle.then((t=>{try{return e.system.destroyVideoRoomHandle(t)}catch(e){return null}})),this.subscriberHandle=Promise.resolve(0)}this.currentSubscriptionId=0,this.updateSubscriptionState()}))}updateSubscriptionState(){(this.currentSubscriptionInfo&&this.currentSubscriptionInfo.publisherId||0)!=this.currentSubscriptionId&&(this.currentSubscriptionInfo&&"function"==typeof this.currentSubscriptionInfo.cancel&&(this.currentSubscriptionInfo.cancel(),this.currentSubscriptionInfo=null),0==this.node.HasToken&&0!=this.currentSubscriptionId&&(this.currentSubscriptionInfo=this.subscribeToCurrent()))}subscribeToCurrent(){let e=new d(this.currentSubscriptionId,this,this.system.remoteMediaFactory);return e.initAsync().catch(this.logErrors),e}parseHandle(e){let t=+e;return"number"!=typeof t?(console.warn(`Invalid handle - ${e} is not a number type`),0):isNaN(t)?(console.warn(`Invalid handle - ${e} is Not a Number`),0):Number.isInteger(t)?t<0?(console.warn(`Invalid handle - ${e} is not a positive integer`),0):t:(console.warn(`Invalid handle - ${e} is not an integer`),0)}logErrors(e){console.error("A promise faulted in WebRtcComponentView",e)}}t.WebRtcComponentView2=o;class a extends t.BaseWebRtcComponentController{constructor(){super(...arguments),this.initCts=new t.CancellationTokenSource,this.publisherId=0,this.isWebRtcUp=!1,this.publisherHandle=0,this.mediaFactoryContext=null,this.mediaFactoryWasInitialized=!1,this.peerConnection=null,this.localMediaStream=null}bindComponent(e,t,n){this.system.statTracker.set(`Controller ${t.id}`,"bound",!0),this.changedHandler=this.component_onComponentChanged.bind(this),n.onChanged.on(this.changedHandler),this.initHandler=this.system_onWebRtcInitialized.bind(this),e.onWebRtcInitialized.on(this.initHandler),this.uninitHandler=this.system_onWebRtcUninitialized.bind(this),e.onWebRtcUninitialized.on(this.uninitHandler),s(this.system.localMediaFactory,"localMediaFactory is not set on the WebRtcComponentSystem - errors will occur if this client attempts to send audio/video in a WebRTC call"),s(this.system.userMediaFactory,"userMediaFactory is not set on the WebRtcComponentSystem - errors will occur if this client attempts to send audio/video in a WebRTC call"),e.isInitialized&&this.startWebRtcAsync(this.initCts).catch(this.logErrors)}unbindComponent(e,t,n){this.system.statTracker.set(`Controller ${t.id}`,"bound",!1),this.changedHandler&&n.onChanged.off(this.changedHandler),this.changedHandler=null,this.initHandler&&e.onWebRtcInitialized.off(this.initHandler),this.initHandler=null,this.uninitHandler&&e.onWebRtcUninitialized.off(this.uninitHandler),this.uninitHandler=null,this.initCts.cancel(),this.stopWebRtcAsync().catch(this.logErrors)}system_onWebRtcInitialized(e){this.startWebRtcAsync(this.initCts).catch(this.logErrors)}system_onWebRtcUninitialized(e){this.stopWebRtcAsync().catch(this.logErrors)}startWebRtcAsync(e){return __awaiter(this,void 0,void 0,(function*(){e=t.CancellationTokenSource.ensure(e),this.system.localPublisherIdChanged.add(this.system_localPublisherIdChanged,this),this.system.sessionObserver.onWebRtcUp.add(this.sessionObserver_onWebRtcUp,this),this.publisherHandle=this.system.getVideoRoomPublishHandle(),s(!this.publisherId,"publisherId was set earlier than expected"),s(!this.isWebRtcUp,"webrtcup was set earlier than expected"),this.updatePublishingState(),this.publisherId=this.system.publisherId,this.updatePublishingState(),s(this.node&&this.node.HasToken,"node no longer exists or we don't own the token"),this.node&&this.node.HasToken&&(yield this.createPeerConnectionAsync(e))}))}stopWebRtcAsync(e,n){return __awaiter(this,void 0,void 0,(function*(){n=t.CancellationTokenSource.ensure(n),this.system&&this.system.sessionObserver&&this.system.sessionObserver.onWebRtcUp.remove(this.sessionObserver_onWebRtcUp),this.publisherHandle=0,this.publisherId=0,this.isWebRtcUp=!1,this.updatePublishingState(),yield this.destroyPeerConnectionAsync(),s(!this.component||"0"==this.component.sndContext,"component.sndContext has not been reset on cleanup"),s(!this.mediaFactoryContext,"media factory was not destroyed on cleanup"),s(!this.mediaFactoryWasInitialized,"media factory was not de-inited on cleanup"),s(!this.publisherHandle,"publisherHandle was not reset"),s(!this.publisherId,"publisherId was not reset")}))}updatePublishingState(){this.node&&this.node.HasToken&&(this.isWebRtcUp?this.component.sndContext=""+this.publisherId:this.component.sndContext="0",this.component.triggerOnChanged())}updateAudioVideoEnabledStates(){if(this.localMediaStream){let e=this.localMediaStream.getAudioTracks(),t=this.localMediaStream.getVideoTracks();for(let t of e)t.enabled=this.component.audio;for(let e of t)e.enabled=this.component.video}}createPeerConnectionAsync(e){return __awaiter(this,void 0,void 0,(function*(){s(this.system.isInitialized,"system is not initialized"),s(!this.mediaFactoryWasInitialized&&!this.mediaFactoryContext,"media has already been instantiated"),s(this.system.localMediaFactory,"no local media factory was provided"),this.system.statTracker.set(`Controller ${this.node.id}`,"vrHandle",this.publisherHandle),this.system.statTracker.set(`vrh${this.publisherHandle}`,"node.id",this.node.id),this.system.statTracker.set(`vrh${this.publisherHandle}`,"node.kind","controller/sender"),this.system.statTracker.set(`vrh${this.publisherHandle}`,"peerConnection","creating..."),this.peerConnection=new RTCPeerConnection({iceServers:this.system.iceServers}),this.system.statTracker.trackPeerConnection(`vrh${this.publisherHandle}`,"rtcStats",this.peerConnection),this.system.statTracker.set(`vrh${this.publisherHandle}`,"iceCandidatesGenerated",0),this.system.statTracker.set(`vrh${this.publisherHandle}`,"iceCandidatesSent",0),this.system.statTracker.set(`vrh${this.publisherHandle}`,"pcStatus.iceGatheringState",this.peerConnection.iceGatheringState),this.system.statTracker.set(`vrh${this.publisherHandle}`,"pcStatus.iceConnectionState",this.peerConnection.iceConnectionState),this.system.statTracker.set(`vrh${this.publisherHandle}`,"pcStatus.connectionState",this.peerConnection.connectionState),this.peerConnection.addEventListener("icecandidate",this.pc_onIceCandidate.bind(this)),this.peerConnection.addEventListener("icegatheringstatechange",this.pc_onIceGatheringStateChange.bind(this)),this.peerConnection.addEventListener("iceconnectionstatechange",this.pc_onIceConnectionStateChange.bind(this)),this.peerConnection.addEventListener("connectionstatechange",this.pc_onConnectionStateChange.bind(this)),this.peerConnection.addEventListener("negotiationneeded",this.pc_onNegotiationNeeded.bind(this)),this.system.setPeerConnectionForHandle(this.publisherHandle,this.peerConnection),this.localMediaStream=new MediaStream;let e=this.updateAudioVideoEnabledStates.bind(this);this.localMediaStream.addEventListener("addtrack",e),this.localMediaStream.addEventListener("removetrack",e),this.mediaFactoryContext=this.system.localMediaFactory.create({peerConnection:this.peerConnection,mediaStream:this.localMediaStream,component:this.component}),this.mediaFactoryWasInitialized=!0,this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.initState","Initializing...");try{yield this.system.userMediaFactory.initializeUserMediaAsync({initAudio:this.system.localAudioEnabled,initVideo:this.system.localVideoEnabled}),this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.initState","Initialized.")}catch(e){throw console.error("[WebRTC] userMediaFactory threw error in initializeUserMediaAsync. This may cause unpredictable results with WebRTC calls.",e),this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.initState","Failed"),e}this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.acquisitionState","Acquiring...");try{let e=yield this.system.userMediaFactory.getCurrentMediaAsync();this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.totalTracksAcquired",e.length);for(let t of e)this.system.statTracker.set(`Controller ${this.node.id}`,`localTracks.${t.id}`,`Adding [${t.kind}] ${t.label}]`),this.localMediaStream.addTrack(t),this.peerConnection.addTrack(t,this.localMediaStream),this.system.statTracker.set(`Controller ${this.node.id}`,`localTracks.${t.id}`,`[${t.kind}] ${t.label}]`);this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.acquisitionState","Complete")}catch(e){console.error("[WebRTC] userMediaFactory threw error in getCurrentMediaAsync. This may cause unpredictable results with WebRTC calls.",e),this.system.statTracker.set(`Controller ${this.node.id}`,"userMedia.acquisitionState","Failed")}this.updateAudioVideoEnabledStates()}))}destroyPeerConnectionAsync(e){return __awaiter(this,void 0,void 0,(function*(){e=t.CancellationTokenSource.ensure(e);try{this.system.localMediaFactory.destroy({peerConnection:this.peerConnection,mediaStream:this.localMediaStream,context:this.mediaFactoryContext,component:this.component}),this.mediaFactoryWasInitialized=!1}catch(e){console.error("[WebRTC] localMediaFactory.destroy threw an error",{originalError:e})}if(this.peerConnection&&this.peerConnection.close(),this.system.statTracker.untrackPeerConnection(this.peerConnection),this.peerConnection=null,this.mediaFactoryContext=null,this.localMediaStream){try{for(let e of this.localMediaStream.getTracks())try{e.enabled=!1,e.stop(),this.localMediaStream.removeTrack(e)}catch(t){console.error("[WebRTC] Failed to stop/remove track from localMediaStream",{stream:this.localMediaStream,track:e,error:t})}}catch(e){console.error("[WebRTC] Failed to remove tracks from localMediaStream",{localMediaStream:this.localMediaStream,error:e})}try{"function"==typeof this.localMediaStream.stop?this.localMediaStream.stop():console.log("[WebRTC] This browser does not have a 'stop' function on MediaStream (attempting to stop localMediaStream)")}catch(e){console.error("[WebRTC] Failed to stop localMediaStream")}this.localMediaStream=null}}))}component_onComponentChanged(e){try{this.updateAudioVideoEnabledStates()}catch(e){this.logErrors(e)}}sessionObserver_onWebRtcUp(e,t){t.sender==this.system.getVideoRoomPublishHandle()&&(console.log("[WebRTC] WebRTC is now up! (media sending successful)",t),this.isWebRtcUp=!0,this.updatePublishingState())}system_localPublisherIdChanged(e,t){console.debug(`[WebRTC] Our Publish ID is now ${t}`),this.publisherId=t,this.updatePublishingState()}pc_onIceCandidate(e){return __awaiter(this,void 0,void 0,(function*(){s(this.publisherHandle,"publisherHandle is not set (ice candidate ready)");let t=e.candidate,n=this.publisherHandle;t?(this.system.statTracker.increment(`vrh${this.publisherHandle}`,"iceCandidatesGenerated"),yield this.system.sendIce(n,t.sdpMid,t.sdpMLineIndex,t.candidate),this.system.statTracker.increment(`vrh${this.publisherHandle}`,"iceCandidatesSent")):(this.system.statTracker.set(`vrh${this.publisherHandle}`,"iceCandidates.complete","Sending"),yield this.system.sendIceComplete(n),this.system.statTracker.set(`vrh${this.publisherHandle}`,"iceCandidates.complete","Sent"))}))}pc_onIceGatheringStateChange(e){this.system.statTracker.set(`vrh${this.publisherHandle}`,"pcStatus.iceGatheringState",this.peerConnection.iceGatheringState)}pc_onIceConnectionStateChange(e){this.system.statTracker.set(`vrh${this.publisherHandle}`,"pcStatus.iceConnectionState",this.peerConnection.iceConnectionState)}pc_onConnectionStateChange(e){this.system.statTracker.set(`vrh${this.publisherHandle}`,"pcStatus.connectionState",this.peerConnection.connectionState)}pc_onNegotiationNeeded(e){return __awaiter(this,void 0,void 0,(function*(){console.log("[WebRTC] PeerConnection needs negotiation",{event:e,peerConnection:e.currentTarget}),this.system.statTracker.set(`vrh${this.publisherHandle}`,"peerConnection","CreatingOffer");let t=yield this.peerConnection.createOffer();this.system.statTracker.set(`vrh${this.publisherHandle}`,"peerConnection","SettingLocalDesc"),yield this.peerConnection.setLocalDescription(t),this.system.statTracker.set(`vrh${this.publisherHandle}`,"peerConnection","MakingOffer"),yield this.system.sendJsep(this.publisherHandle,t.type,t.sdp),this.system.statTracker.set(`vrh${this.publisherHandle}`,"peerConnection","SentOffer")}))}logErrors(e){console.error("A promise faulted in WebRtcComponentView",e)}}t.WebRtcComponentController2=a;class d{constructor(e,n,i){this.cts=new t.CancellationTokenSource,this.cts.register(this.onCancelled.bind(this)),this.publisherId=e,this.view=n,this.mediaFactory=i}get component(){return this.view.component}get node(){return this.view.node}get system(){return this.view.system}initAsync(){return __awaiter(this,void 0,void 0,(function*(){this.publisherId&&(s(this.mediaFactory,"no mediaFactory was provided"),yield Promise.race([this.system.isInitializedAsyncTask(),this.cts.promise()]),this.cts.isCancellationRequested||this.view.isValidCall()&&(this.subscriberHandle=yield this.view.subscriberHandle,[this.peerConnection,this.mediaStream]=this.createIncomingPeerConnection(),this.factoryContext=this.mediaFactory.create({peerConnection:this.peerConnection,mediaStream:this.mediaStream,component:this.component}),0!=this.subscriberHandle&&0!=this.publisherId&&(this.system.setPeerConnectionForHandle(this.subscriberHandle,this.peerConnection),0==this.view._hasSubscribedToAny?(this.view._hasSubscribedToAny=!0,yield this.system.subscribeTo(this.subscriberHandle,this.publisherId)):yield this.system.switchSubscriptionTo(this.subscriberHandle,this.publisherId))))}))}cancel(){this.cts.cancel()}onCancelled(){this.mediaFactory.destroy({peerConnection:this.peerConnection,mediaStream:this.mediaStream,context:this.factoryContext,component:this.component}),this.factoryContext=null,this.destroyPeerConnection()}createIncomingPeerConnection(){this.system.statTracker.set(`View ${this.node.id}`,"vrHandle",this.subscriberHandle),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"node.id",this.node.id),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"node.kind","view/receiver"),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"peerConnection","creating...");let e=new RTCPeerConnection({iceServers:this.system.iceServers});this.system.statTracker.trackPeerConnection(`vrh${this.subscriberHandle}`,"rtcStats",e),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"iceCandidatesGenerated",0),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"iceCandidatesSent",0),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"pcStatus.iceGatheringState",e.iceGatheringState),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"pcStatus.iceConnectionState",e.iceConnectionState),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"pcStatus.connectionState",e.connectionState),e.addEventListener("icecandidate",this.pc_onIceCandidate.bind(this)),e.addEventListener("icegatheringstatechange",(t=>{this.system.statTracker.set(`vrh${this.subscriberHandle}`,"pcStatus.iceGatheringState",e.iceGatheringState)})),e.addEventListener("iceconnectionstatechange",(t=>{this.system.statTracker.set(`vrh${this.subscriberHandle}`,"pcStatus.iceGatheringState",e.iceGatheringState)})),e.addEventListener("connectionstatechange",(t=>{this.system.statTracker.set(`vrh${this.subscriberHandle}`,"pcStatus.iceGatheringState",e.iceGatheringState)})),e.addEventListener("track",this.pc_onTrack.bind(this));let t=new MediaStream;return this.system.statTracker.set(`vrh${this.subscriberHandle}`,"peerConnection","Created"),[e,t]}destroyPeerConnection(){if(this.mediaStream){for(let e of this.mediaStream.getTracks())e.enabled=!1,e.stop(),this.mediaStream.removeTrack(e);"function"==typeof this.mediaStream.stop&&this.mediaStream.stop(),this.mediaStream=null}this.peerConnection&&(this.peerConnection.close(),this.system.statTracker.untrackPeerConnection(this.peerConnection),this.peerConnection=null)}pc_onIceCandidate(e){return __awaiter(this,void 0,void 0,(function*(){s(this.subscriberHandle,"subscriberHandle is not set (ice candidate ready)");let t=e.candidate,n=this.subscriberHandle;t?(this.system.statTracker.increment(`vrh${this.subscriberHandle}`,"iceCandidatesGenerated"),yield this.system.sendIce(n,t.sdpMid,t.sdpMLineIndex,t.candidate),this.system.statTracker.increment(`vrh${this.subscriberHandle}`,"iceCandidatesSent")):(this.system.statTracker.set(`vrh${this.subscriberHandle}`,"iceCandidates.complete","Sending"),yield this.system.sendIceComplete(n),this.system.statTracker.set(`vrh${this.subscriberHandle}`,"iceCandidates.complete","Sent"))}))}pc_onTrack(e){s(this.mediaStream,"mediaStream is not ready (ontrack)"),this.system.statTracker.set(`vrh${this.subscriberHandle}`,`remote_${e.track.id}`,`[${e.track.kind}/${e.track.enabled}] ${e.track.label}`),this.mediaStream.addTrack(e.track)}}}(t=e.NodeComponentModel||(e.NodeComponentModel={}))}(Vertex||(Vertex={})),function(e){let t;!function(t){class n{constructor(){this.showObjects=!1,this.arrayBreakout=4,this.excludedProperties=new Array,this.customRenderers=new Map,this.onInputChanged=new e.EventBus,this.wasModified=!1}propertyRenderer(e,t){this.customRenderers.set(e,t)}excludeProperty(e){this.excludedProperties.push(e)}handleInputChangedEvent(e){this.onInputChanged.trigger(e),this.wasModified=!0}bind(e,t){for(var n in this.targetElement=e,this.targetElement.innerHTML="",this.target=t,this.title&&this.renderTitleBar(this.title),this.target){let e=this.renderDataRow.bind(this);if(this.customRenderers.has(n)){let t=this.customRenderers.get(n);e=t.RenderProperty.bind(t)}var i=e(n,t);i&&this.targetElement.appendChild(i)}}renderTitleBar(t){var n=document.createElement("div");n.classList.add("row","control-heading","control-heading-pin-top");var i=document.createElement("div");i.classList.add("col","pl-1"),i.innerText=t,n.appendChild(i);let s=document.createElement("div");s.classList.add("inspector-delete-btn"),s.innerHTML="&times;",s.title="Remove Component";let r=this;s.addEventListener("click",(()=>{let t=r.target;"name"in t!=0?this.targetNode?(this.targetNode.removeComponent(t.name),console.log(`Removed '${t.name} component from node.`),e.Globals.event.fire("editor:selectNode",this.targetNode)):console.error("Delete Component was invoked, but the inspector does not have a targetNode assigned."):console.error("Delete Component was invoked, but the inspector target did not seem to be a component.")})),n.appendChild(s),this.targetElement.appendChild(n)}renderDataRow(t,i){if(-1!==this.excludedProperties.indexOf(t))return;var s=i[t];if(null==s)return;if(s.toString().startsWith("[object Object]")&&!1===this.showObjects){if(s instanceof e.NodeComponentModel.Structure){let e=document.createElement("div");e.classList.add("row","control-group"),e.classList.add("row","m-1"),e.style.backgroundColor="#171718",e.dataset.vtxBinding=i.name+"."+t;let r=document.createElement("div");r.classList.add("col-12","control-heading"),r.style.textAlign="left",r.innerText=t;let o=document.createElement("div");o.classList.add("col-12","inspector-control-section"),s.name=t,s._isStructure=!0;let a=new n;a.arrayBreakout=0,a.excludedProperties.push("name"),a.excludedProperties.push("_isStructure"),a.bind(o,s);let d=this;return a.onInputChanged.on((n=>{let r=n.target,o=n.target.dataset.vtxBinding;if(console.log(o),o&&o.startsWith(t)){let e=o;e=e.split(".")[1],s[e],"number"==typeof s[e]?s[e]=r.valueAsNumber:(s[e],s[e]=""+r.value)}d.handleInputChangedEvent({srcElement:e,target:e,getAttribute:function(e){return i.name+"."+t}})})),e.appendChild(r),e.appendChild(o),e}return}let r=document.createElement("div");r.classList.add("row","control-group");let o=Array.isArray(s);var a=document.createElement("div");if(a.classList.add("col-3","control-label"),a.innerText=t,o){let n=this;a.style.cursor="pointer",a.title="Click to Set Array Size",a.addEventListener("click",(s=>{let o=document.createElement("div");o.classList.add("control-value"),o.style.position="fixed",o.style.left=s.clientX-40+"px",o.style.top=s.clientY-20+"px",o.style.width="80px";let a=this.renderInputField("","number");a.placeholder="Array Length";let d=function(e){switch(e){case"number":return 0;case"boolean":return!1;default:return""}};a.addEventListener("blur",(e=>{o.parentNode&&o&&o.parentNode.removeChild(o)})),a.addEventListener("keyup",(s=>{switch(s.key){case"Escape":a.blur();break;case"Enter":!function(s){if("number"!=typeof s)return void console.warn("Array Size was not a number");if(isNaN(s))return void console.warn("Array Size was NaN, not setting.");if(s<0)return void console.warn("Not setting array size less than 0");if(s>32)return void console.warn("Not setting array size greater than 32");new Promise(((e,n)=>{let s=i.writeDataBSON;if("function"!=typeof s)throw"BSON Writer not found";let r=null;var o={startObject:()=>{},endObject:()=>{null!=r?e(r):n()},writeInt16:()=>"number",writeInt32:()=>"number",writeInt64:()=>"number",writeUInt16:()=>"number",writeUInt32:()=>"number",writeUInt64:()=>"number",writeSingle:()=>"number",writeDouble:()=>"number",writeString:()=>"string",writeBoolean:()=>"boolean",writeArray:(e,n,i)=>{e.toLowerCase()===t.toLowerCase()&&(r=i())}};s.call(i,o),window.setTimeout(n,300)})).then((r=>{console.log("Array type is",r);let o=i[t].length;i[t]=i[t].slice(0,s);for(let e=o;e<s;++e)i[t][e]=d(r);i.triggerOnChanged(),e.Globals.event.fire("editor:clearSelection"),e.Globals.event.fire("editor:selectNode",n.targetNode)})).catch((e=>{console.warn("Cannot determine array type",e)}))}(+a.value),a.blur()}})),o.appendChild(a),r.appendChild(o),a.focus()}))}r.appendChild(a);var d=document.createElement("div");d.classList.add("col","control-value");var c=null;if(o)if(s.length<=this.arrayBreakout){var l=0;for(var h of s)(c=this.renderInputField(h,typeof i[t][l])).setAttribute("data-vtx-binding",i.name+"."+t+"."+l),c.setAttribute("data-vtx-array",l.toString()),c.addEventListener("change",this.handleInputChangedEvent.bind(this)),d.appendChild(c),l++}else(c=this.renderInputField(s,typeof i[t])).setAttribute("data-vtx-binding",i.name+"."+t),c.addEventListener("change",this.handleInputChangedEvent.bind(this)),d.appendChild(c);else(c=this.renderInputField(s,typeof i[t])).setAttribute("data-vtx-binding",i.name+"."+t),c.addEventListener("change",this.handleInputChangedEvent.bind(this)),d.appendChild(c);return r.appendChild(d),r}renderInputField(e,t){if("boolean"===t){var n=document.createElement("select");n.classList.add("form-control");var i=document.createElement("option");i.value="true",i.innerText="True",i.selected=!!e;var s=document.createElement("option");return s.value="false",s.innerText="False",s.selected=!e,n.appendChild(i),n.appendChild(s),n}var r=document.createElement("input");return r.classList.add("form-control"),r.autocomplete="off",r.value=e,r.type="text","number"==typeof e&&(r.type="number",0!==e&&(r.value=e.toPrecision(4))),r.spellcheck=!1,r}}t.InspectorPanel=n}(t=e.UI||(e.UI={}))}(Vertex||(Vertex={})),function(e){let t;!function(e){e.ScrollFlex=class{constructor(){let e=document.createElement("span");e.classList.add("scrollFlex");let t,n,i=!1;e.addEventListener("mousedown",(s=>{s.preventDefault(),i=!0,e.classList.add("active"),t=s.pageX-e.offsetLeft,n=e.scrollLeft})),document.addEventListener("mouseup",(t=>{i&&(t.stopPropagation(),t.preventDefault(),i=!1,e.classList.remove("active"))})),document.addEventListener("mousemove",(s=>{if(s.stopPropagation(),!i)return;s.preventDefault();const r=3*(s.pageX-e.offsetLeft-t);e.scrollLeft=n-r})),e.addEventListener("drag",(e=>{e.stopPropagation()})),this.scrollingDiv=e}}}(t=e.UI||(e.UI={}))}(Vertex||(Vertex={}));
//# sourceMappingURL=index.d681d884.js.map
